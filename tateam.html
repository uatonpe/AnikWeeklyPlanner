<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>TA Team Sync | LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fafafa; }
        .sync-card { background: white; border-radius: 20px; border: 1px solid #e5e7eb; overflow: hidden; }
        .input-actual { background: #f0fdf4; border: 2px solid #bbf7d0; padding: 10px; border-radius: 10px; font-weight: 800; text-align: center; }
    </style>
</head>
<body class="p-6 md:p-12">
    <nav class="max-w-6xl mx-auto flex justify-between items-center mb-10 border-b-4 border-emerald-500 pb-6">
        <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-10">
        <h2 class="text-2xl font-black text-emerald-800 uppercase">TA System Entry</h2>
    </nav>

    <main class="max-w-6xl mx-auto">
        <div class="bg-white p-8 rounded-3xl shadow-sm mb-10 grid grid-cols-1 md:grid-cols-2 gap-8 items-end border border-slate-100">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">मॅनेजर निवडा</label>
                <select id="mgrSelect" class="w-full p-4 border-2 rounded-2xl font-bold bg-slate-50" onchange="loadManagerHistory()">
                    <option value="">-- निवडा --</option>
                </select>
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">उपलब्ध प्लॅन निवडा</label>
                <select id="planSelect" class="w-full p-4 border-2 rounded-2xl font-bold bg-slate-50" onchange="loadActualsTable()">
                    <option value="">-- आधी मॅनेजर निवडा --</option>
                </select>
            </div>
        </div>

        <div id="syncTableContainer" class="hidden sync-card shadow-2xl">
            <table class="w-full text-left">
                <thead class="bg-slate-900 text-white text-[11px] uppercase tracking-widest">
                    <tr><th class="p-6">स्टाफ आणि कामकाज</th><th class="p-6 text-center">टार्गेट</th><th class="p-6 text-center">सिस्टीम अ‍ॅक्चुअल</th></tr>
                </thead>
                <tbody id="taBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div id="actionBox" class="hidden mt-10 flex justify-end">
            <button onclick="updateData()" class="bg-emerald-600 text-white px-12 py-5 rounded-2xl font-black uppercase tracking-widest hover:scale-105 transition-all shadow-xl">
                सिस्टम डेटा सिंक करा
            </button>
        </div>
    </main>

    <script>
        const SCRIPT_URL = "तुमची_DEPLOY_केलेली_URL_येथे_टाका"; 
        let historyData = [];

        async function init() {
            const resp = await fetch(`${SCRIPT_URL}?action=getManagers`);
            const managers = await resp.json();
            const sel = document.getElementById('mgrSelect');
            managers.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
        }

        async function loadManagerHistory() {
            const mgr = document.getElementById('mgrSelect').value;
            const resp = await fetch(`${SCRIPT_URL}?action=getManagerData&manager=${encodeURIComponent(mgr)}`);
            const data = await resp.json();
            historyData = data.history;

            const planSel = document.getElementById('planSelect');
            planSel.innerHTML = '<option value="">-- प्लॅन निवडा --</option>';
            historyData.forEach((h, i) => {
                planSel.innerHTML += `<option value="${i}">Week: ${h.sDate} to ${h.eDate}</option>`;
            });
        }

        function loadActualsTable() {
            const idx = document.getElementById('planSelect').value;
            if(!idx) return;

            const plan = historyData[idx];
            const body = document.getElementById('taBody');
            body.innerHTML = "";
            document.getElementById('syncTableContainer').classList.remove('hidden');
            document.getElementById('actionBox').classList.remove('hidden');

            plan.details.forEach((item, i) => {
                body.innerHTML += `
                    <tr>
                        <td class="p-6 font-bold text-slate-700">${item.name}</td>
                        <td class="p-6 text-center font-black text-blue-600">₹ ${item.tDisb}</td>
                        <td class="p-6"><input type="number" class="act-val input-actual w-full" value="${item.aDisb}" data-index="${i}"></td>
                    </tr>
                `;
            });
        }

        async function updateData() {
            const idx = document.getElementById('planSelect').value;
            const plan = historyData[idx];
            
            const updatedDetails = plan.details.map((item, i) => {
                return {
                    ...item,
                    aDisb: document.querySelectorAll('.act-val')[i].value
                };
            });

            const payload = { manager: document.getElementById('mgrSelect').value, sDate: plan.sDate, eDate: plan.eDate, fxDetails: updatedDetails };

            const resp = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await resp.json();
            alert(result.message);
            location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>
