<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Executive Strategic Portal | Power BI Style</title>
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --pbi-dark: #121212;
            --pbi-card: #1e1e1e;
            --pbi-accent: #f2c811; /* Power BI Yellow */
            --pbi-blue: #0078d4;
            --pbi-text: #ffffff;
        }
        body {
            background-color: var(--pbi-dark);
            color: var(--pbi-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        .sidebar { background-color: #000; height: 100vh; width: 80px; position: fixed; left: 0; top: 0; border-right: 1px solid #333; }
        .main-content { margin-left: 80px; padding: 2rem; }
        .glass-card { background: var(--pbi-card); border: 1px solid #333; border-radius: 8px; transition: all 0.3s; }
        .glass-card:hover { border-color: var(--pbi-accent); }
        .kpi-title { font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--pbi-accent); }
        .pbi-table { width: 100%; border-collapse: collapse; }
        .pbi-table th { background: #2d2d2d; color: #888; font-size: 0.7rem; text-transform: uppercase; padding: 12px; text-align: left; }
        .pbi-table td { padding: 12px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .pbi-input { background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 4px; padding: 8px; width: 100%; outline: none; }
        .pbi-input:focus { border-color: var(--pbi-accent); }
        .loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--pbi-accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="pbiLoader" class="loader-overlay">
        <div class="spinner"></div>
        <p class="mt-4 font-bold tracking-widest text-sm" style="color: var(--pbi-accent)">CONNECTING TO LIVE SERVER...</p>
    </div>

    <!-- Sidebar Iconography -->
    <div class="sidebar hidden md:flex flex-col items-center py-8 gap-10">
        <div class="text-white opacity-50 hover:opacity-100 cursor-pointer">üè†</div>
        <div class="text-white opacity-100 cursor-pointer" style="border-left: 3px solid var(--pbi-accent); padding-left: 5px;">üìä</div>
        <div class="text-white opacity-50 hover:opacity-100 cursor-pointer">‚öôÔ∏è</div>
    </div>

    <div class="main-content">
        <!-- Top Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Executive Strategy <span style="color: var(--pbi-accent)">Dashboard</span></h1>
                <p class="text-gray-500 text-sm">Real-time FX Weekly Performance Tracker ‚Ä¢ v4.0 Final</p>
            </div>
            <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                <div class="bg-gray-900 p-2 rounded-lg border border-gray-700">
                    <label class="block text-[10px] text-gray-400 font-bold uppercase mb-1">Select Manager</label>
                    <select id="managerSelector" onchange="initWorkspace()" class="bg-transparent text-white font-bold outline-none cursor-pointer pr-8">
                        <option value="">-- Loading... --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Initial Blank Screen -->
        <div id="blankState" class="flex flex-col items-center justify-center h-[50vh] opacity-20">
            <h2 class="text-4xl font-bold uppercase tracking-[10px]">Access Required</h2>
            <p class="mt-4">Please select a manager from the top right to load strategic data</p>
        </div>

        <!-- Dashboard Workspace -->
        <div id="workspace" class="hidden animate-in fade-in duration-700">
            
            <!-- KPI Tiles -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-card p-6">
                    <p class="kpi-title">Projected Disbursement</p>
                    <h3 id="liveDisb" class="kpi-value">‚Çπ 0.00</h3>
                    <div class="w-full bg-gray-800 h-1 mt-4"><div class="bg-yellow-500 h-1" style="width: 65%"></div></div>
                </div>
                <div class="glass-card p-6">
                    <p class="kpi-title">Average Achievement %</p>
                    <h3 id="liveAch" class="kpi-value">0%</h3>
                    <div class="w-full bg-gray-800 h-1 mt-4"><div class="bg-blue-500 h-1" style="width: 40%"></div></div>
                </div>
                <div class="glass-card p-6">
                    <p class="kpi-title">Total OD Accounts</p>
                    <h3 id="liveOd" class="kpi-value">0</h3>
                    <div class="w-full bg-gray-800 h-1 mt-4"><div class="bg-red-500 h-1" style="width: 25%"></div></div>
                </div>
                <div class="glass-card p-6">
                    <p class="kpi-title">FX Units Mapped</p>
                    <h3 id="liveUnits" class="kpi-value">0</h3>
                    <div class="w-full bg-gray-800 h-1 mt-4"><div class="bg-green-500 h-1" style="width: 100%"></div></div>
                </div>
            </div>

            <!-- Visualization Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <div class="glass-card p-6">
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-6 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-yellow-500"></span> Previous Week Performance (FX Wise)
                    </h4>
                    <div class="h-[250px]"><canvas id="barChart"></canvas></div>
                </div>
                <div class="glass-card p-6">
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-6 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span> OD Coverage Distribution
                    </h4>
                    <div class="h-[250px]"><canvas id="lineChart"></canvas></div>
                </div>
            </div>

            <!-- Strategic Input Table -->
            <div class="glass-card overflow-hidden">
                <div class="bg-[#252525] p-6 flex flex-col md:flex-row gap-8 justify-between">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div>
                            <label class="kpi-title mb-2 block">Plan Start Date</label>
                            <input type="date" id="sDate" class="pbi-input">
                        </div>
                        <div>
                            <label class="kpi-title mb-2 block">Plan End Date</label>
                            <input type="date" id="eDate" class="pbi-input">
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button onclick="submitFinalPlan()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-10 py-3 rounded uppercase text-sm tracking-widest transition-all">Submit Weekly Plan</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="pbi-table">
                        <thead>
                            <tr>
                                <th>FX UNIT NAME</th>
                                <th>DISBURSEMENT (‚Çπ)</th>
                                <th>AUTO-PAY (‚Çπ)</th>
                                <th>OD (QTY | AMT)</th>
                                <th>PAST DUE ACTION PLAN</th>
                                <th style="color: var(--pbi-accent)">PREV ACH %</th>
                            </tr>
                        </thead>
                        <tbody id="fxTableBody">
                            <!-- Rows injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const APP_URL = "https://script.google.com/macros/s/AKfycbwHg4SmoLrehfinJj3uwMbXiyxIZZ_ZaBT09dmxwUxoFzBg3ULbEz_0xJez3HvxV37f/exec";
        let chartInstance1, chartInstance2;

        // ‡•ß. ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§≤‡§æ ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡§ø‡§≥‡§µ‡§£‡•á
        window.onload = async () => {
            toggleLoader(true);
            try {
                const response = await fetch(`${APP_URL}?action=getManagers`);
                const managers = await response.json();
                const selector = document.getElementById('managerSelector');
                selector.innerHTML = '<option value="">-- Select Manager --</option>';
                managers.forEach(m => selector.add(new Option(m, m)));
            } catch (e) {
                console.error("API Error:", e);
                alert("Database Connection Failed!");
            }
            toggleLoader(false);
        };

        // ‡•®. ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§®‡§ø‡§µ‡§°‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§µ‡§∞‡•ç‡§ï‡§∏‡•ç‡§™‡•á‡§∏ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•á
        async function initWorkspace() {
            const manager = document.getElementById('managerSelector').value;
            if (!manager) {
                document.getElementById('workspace').classList.add('hidden');
                document.getElementById('blankState').classList.remove('hidden');
                return;
            }

            toggleLoader(true);
            try {
                const response = await fetch(`${APP_URL}?action=getDetails&manager=${encodeURIComponent(manager)}`);
                const { fxList, prevData } = await response.json();

                document.getElementById('blankState').classList.add('hidden');
                const ws = document.getElementById('workspace');
                ws.classList.remove('hidden');
                document.getElementById('liveUnits').innerText = fxList.length;

                renderTable(fxList);
                if(prevData) renderAnalytics(prevData.fxDetails);
                
                // Reset live values
                document.getElementById('liveDisb').innerText = "‚Çπ 0.00";
                document.getElementById('liveOd').innerText = "0";
            } catch (e) {
                console.error(e);
            }
            toggleLoader(false);
        }

        // ‡•©. ‡§ü‡•á‡§¨‡§≤ ‡§ú‡§®‡§∞‡•á‡§∂‡§®
        function renderTable(list) {
            const tbody = document.getElementById('fxTableBody');
            tbody.innerHTML = list.map(fx => `
                <tr class="hover:bg-[#252525] transition-colors">
                    <td class="font-bold text-gray-300 capitalize">${fx}<input type="hidden" class="fx-name" value="${fx}"></td>
                    <td><input type="number" class="pbi-input fx-disb" placeholder="0.00" oninput="calculateLiveStats()"></td>
                    <td><input type="number" class="pbi-input fx-auto" placeholder="0.00"></td>
                    <td>
                        <div class="flex gap-2">
                            <input type="number" class="pbi-input fx-odq" style="width: 70px" placeholder="Qty" oninput="calculateLiveStats()">
                            <input type="number" class="pbi-input fx-oda" placeholder="Amt">
                        </div>
                    </td>
                    <td><input type="text" class="pbi-input fx-pd" placeholder="Strategic Action..."></td>
                    <td><input type="number" class="pbi-input fx-ach" style="color: var(--pbi-accent); font-weight: bold" placeholder="0"></td>
                </tr>
            `).join('');
        }

        // ‡•™. ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§Ü‡§£‡§ø ‡§Ö‡•Ö‡§®‡•Ö‡§≤‡§ø‡§∏‡§ø‡§∏
        function renderAnalytics(data) {
            const labels = data.map(f => f.name);
            const achs = data.map(f => f.ach || 0);
            const ods = data.map(f => f.odCount || 0);

            const avgAch = (achs.reduce((a, b) => a + Number(b), 0) / achs.length).toFixed(1);
            document.getElementById('liveAch').innerText = avgAch + "%";

            // Bar Chart
            if(chartInstance1) chartInstance1.destroy();
            chartInstance1 = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Achievement %', data: achs, backgroundColor: '#f2c811', barThickness: 20 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } } }
            });

            // Line Chart
            if(chartInstance2) chartInstance2.destroy();
            chartInstance2 = new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'OD Qty', data: ods, borderColor: '#0078d4', tension: 0.4, fill: true, backgroundColor: 'rgba(0,120,212,0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } } }
            });
        }

        // ‡•´. ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§Ü‡§ï‡§°‡•á‡§Æ‡•ã‡§°
        function calculateLiveStats() {
            let totalD = 0, totalO = 0;
            document.querySelectorAll('.fx-disb').forEach(i => totalD += Number(i.value || 0));
            document.querySelectorAll('.fx-odq').forEach(i => totalO += Number(i.value || 0));
            document.getElementById('liveDisb').innerText = "‚Çπ " + totalD.toLocaleString('hi-IN');
            document.getElementById('liveOd').innerText = totalO;
        }

        // ‡•¨. ‡§´‡§æ‡§Ø‡§®‡§≤ ‡§∏‡§¨‡§Æ‡§ø‡§ü (Post Data)
        async function submitFinalPlan() {
            const manager = document.getElementById('managerSelector').value;
            const sDate = document.getElementById('sDate').value;
            const eDate = document.getElementById('eDate').value;

            if(!sDate || !eDate) { alert("Please select Dates!"); return; }

            toggleLoader(true);
            const fxDetails = [];
            document.querySelectorAll('#fxTableBody tr').forEach(row => {
                fxDetails.push({
                    name: row.querySelector('.fx-name').value,
                    disb: row.querySelector('.fx-disb').value,
                    auto: row.querySelector('.fx-auto').value,
                    odCount: row.querySelector('.fx-odq').value,
                    odAmt: row.querySelector('.fx-oda').value,
                    pd: row.querySelector('.fx-pd').value,
                    ach: row.querySelector('.fx-ach').value
                });
            });

            const payload = { manager, sDate, eDate, fxDetails };

            try {
                const response = await fetch(APP_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if(result.status === "SUCCESS") {
                    alert("Weekly Plan Submitted Successfully!");
                    location.reload();
                }
            } catch (e) {
                alert("Submission Failed!");
            }
            toggleLoader(false);
        }

        function toggleLoader(show) {
            document.getElementById('pbiLoader').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
