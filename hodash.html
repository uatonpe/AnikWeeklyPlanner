<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Fin | HO Advanced Strategy & Audit Command Center</title>

    <!-- External Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #1e40af;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-light);
            color: #1e293b;
            letter-spacing: -0.02em;
        }

        /* Premium UI Elements */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 1000;
        }

        .premium-card {
            background: white;
            border-radius: 28px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
        }

        /* KPI Progress Bars */
        .kpi-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .kpi-bar-fill { height: 100%; transition: width 1s ease-in-out; }

        /* Status Badges */
        .status-badge { padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .badge-elite { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-average { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
        .badge-critical { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        /* Custom Scrollbar for 1000+ rows */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Print Styling - A4 Audit Layout */
        @media print {
            .no-print { display: none !important; }
            #printArea { display: block !important; width: 100%; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 10px; font-size: 11px; text-align: left; }
            .print-header { text-align: center; border-bottom: 3px solid #1e40af; padding-bottom: 20px; }
            @page { size: A4; margin: 15mm; }
        }
        #printArea { display: none; }

        /* Loading Animation */
        .loading-ring {
            width: 50px; height: 50px;
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="custom-scroll">

    <!-- 1. PROFESSIONAL PRINT LAYOUT -->
    <div id="printArea">
        <div class="print-header">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" style="height: 50px; margin: 0 auto;">
            <h1 style="font-size: 26px; font-weight: 900; color: #1e40af; margin-top: 10px;">ANIK FINANCIAL SERVICES PVT LTD</h1>
            <p style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: #555;">Strategy Achievement & Audit Matrix Report</p>
        </div>
        <div style="display: flex; justify-content: space-between; margin: 30px 0; font-size: 13px; font-weight: bold; border: 1px solid #eee; padding: 15px; border-radius: 10px;">
            <div> मैनेजर: <span id="p_mgr_name">-</span> </div>
            <div> कालावधी: <span id="p_date_range">-</span> </div>
            <div> रिपोर्ट आयडी: #AF/<span id="p_report_id">000</span> </div>
        </div>
        <table class="print-table">
            <thead>
                <tr style="background-color: #f8fafc;">
                    <th>Sr.</th>
                    <th>Staff Name</th>
                    <th>KPI Description</th>
                    <th style="text-align: right;">Target</th>
                    <th style="text-align: right;">Achieved</th>
                    <th style="text-align: center;">%</th>
                </tr>
            </thead>
            <tbody id="print_table_body"></tbody>
        </table>
        <div style="margin-top: 80px; display: flex; justify-content: space-between; padding: 0 40px;">
            <div style="text-align: center;"><div style="border-top: 1px solid #000; width: 180px; margin-bottom: 5px;"></div><p>Area Manager Signature</p></div>
            <div style="text-align: center;"><div style="border-top: 1px solid #000; width: 180px; margin-bottom: 5px;"></div><p>HO Strategy Auditor</p></div>
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD UI -->
    <nav class="glass-header sticky top-0 h-20 no-print">
        <div class="max-w-[1750px] mx-auto px-8 h-full flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="bg-blue-600 p-2.5 rounded-2xl shadow-lg shadow-blue-200">
                    <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-5 brightness-0 invert">
                </div>
                <div class="h-10 w-[1px] bg-slate-200"></div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 tracking-tighter uppercase">HO Strategy Matrix</h1>
                    <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Enterprise Performance Command Center</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="bg-slate-100 px-4 py-2.5 rounded-2xl flex items-center gap-3 border border-slate-200">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                    <input type="text" id="globalDateRange" class="bg-transparent text-sm font-bold outline-none w-44 cursor-pointer" placeholder="Select Period">
                </div>
                <button onclick="fetchAllData()" class="bg-slate-800 hover:bg-black text-white px-6 py-2.5 rounded-2xl font-bold text-xs flex items-center gap-3 transition-all">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> डेटा रिफ्रेश
                </button>
                <button onclick="generateAuditReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-7 py-2.5 rounded-2xl font-bold text-xs shadow-xl shadow-blue-200 flex items-center gap-3 transition-all">
                    <i data-lucide="printer" class="w-4 h-4"></i> ऑडिट रिपोर्ट
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1750px] mx-auto p-8 space-y-8 no-print">

        <!-- Filter & High-Level Summary -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div class="md:col-span-3 premium-card p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">मॅनेजर निवडा</label>
                    <select id="mgrDropdown" onchange="syncStaffDropdown()" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl font-bold text-slate-700 outline-none focus:ring-4 ring-blue-500/10 transition-all appearance-none"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">स्टाफ निवडा (Unique)</label>
                    <select id="staffDropdown" onchange="processAndRender()" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl font-bold text-slate-700 outline-none focus:ring-4 ring-blue-500/10 transition-all appearance-none"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">नाव शोधा (Search)</label>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="searchBox" oninput="processAndRender()" placeholder="स्टाफ नाव टाईप करा..." class="w-full bg-slate-50 border border-slate-100 p-4 pl-12 rounded-2xl font-bold text-slate-700 outline-none focus:ring-4 ring-blue-500/10 transition-all">
                    </div>
                </div>
            </div>

            <div class="premium-card p-8 bg-gradient-to-br from-blue-700 to-indigo-900 border-none flex flex-col justify-center items-center text-white relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 opacity-10"><i data-lucide="award" class="w-32 h-32"></i></div>
                <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2 z-10">Overall Efficiency</p>
                <h2 id="overallAchv" class="text-6xl font-black z-10 tracking-tighter">0%</h2>
                <div class="mt-4 bg-white/10 px-4 py-1.5 rounded-full text-[10px] font-bold z-10">ENTERPRISE SCORE</div>
            </div>
        </section>

        <!-- KPI Power Scoreboard (7 Strategic Pillars) -->
        <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6">
            <!-- Disb -->
            <div onclick="showKPIStats('disb', 'Disbursement')" class="premium-card p-6 border-b-4 border-b-blue-600 cursor-pointer">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Disbursement</p>
                <h3 id="v_disb" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-bar-bg"><div id="b_disb" class="kpi-bar-fill bg-blue-600" style="width: 0%"></div></div>
                <div id="p_disb" class="mt-2 text-[10px] font-extrabold text-blue-600">0% Achieved</div>
            </div>
            <!-- Appraisal -->
            <div onclick="showKPIStats('appr', 'Appraisal')" class="premium-card p-6 border-b-4 border-b-indigo-500 cursor-pointer">
                <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="file-check" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Appraisal</p>
                <h3 id="v_appr" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-bar-bg"><div id="b_appr" class="kpi-bar-fill bg-indigo-500" style="width: 0%"></div></div>
                <div id="p_appr" class="mt-2 text-[10px] font-extrabold text-indigo-600">0% Achieved</div>
            </div>
            <!-- OD -->
            <div onclick="showKPIStats('od', 'OD Recovery')" class="premium-card p-6 border-b-4 border-b-rose-500 cursor-pointer">
                <div class="w-10 h-10 bg-rose-50 text-rose-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">OD Recovery</p>
                <h3 id="v_od" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-bar-bg"><div id="b_od" class="kpi-bar-fill bg-rose-500" style="width: 0%"></div></div>
                <div id="p_od" class="mt-2 text-[10px] font-extrabold text-rose-600">0% Achieved</div>
            </div>
            <!-- Regular -->
            <div onclick="showKPIStats('reg', 'Regular Coll.')" class="premium-card p-6 border-b-4 border-b-emerald-500 cursor-pointer">
                <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="calendar-check" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Regular Coll.</p>
                <h3 id="v_reg" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-bar-bg"><div id="b_reg" class="kpi-bar-fill bg-emerald-500" style="width: 0%"></div></div>
                <div id="p_reg" class="mt-2 text-[10px] font-extrabold text-emerald-600">0% Achieved</div>
            </div>
            <!-- Past Due -->
            <div onclick="showKPIStats('past', 'Past Due')" class="premium-card p-6 border-b-4 border-b-amber-500 cursor-pointer">
                <div class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="history" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Past Due</p>
                <h3 id="v_past" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-bar-bg"><div id="b_past" class="kpi-bar-fill bg-amber-500" style="width: 0%"></div></div>
                <div id="p_past" class="mt-2 text-[10px] font-extrabold text-amber-600">0% Achieved</div>
            </div>
            <!-- Rocket -->
            <div onclick="showKPIStats('rock', 'Rocket Pay')" class="premium-card p-6 border-b-4 border-b-purple-500 cursor-pointer">
                <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="rocket" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Rocket Pay</p>
                <h3 id="v_rock" class="text-lg font-black text-slate-800">0</h3>
                <div class="kpi-bar-bg"><div id="b_rock" class="kpi-bar-fill bg-purple-500" style="width: 0%"></div></div>
                <div id="p_rock" class="mt-2 text-[10px] font-extrabold text-purple-600">0% Achieved</div>
            </div>
            <!-- Meetings -->
            <div onclick="showKPIStats('meet', 'Meetings')" class="premium-card p-6 border-b-4 border-b-cyan-500 cursor-pointer">
                <div class="w-10 h-10 bg-cyan-50 text-cyan-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="users-2" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Meetings</p>
                <h3 id="v_meet" class="text-lg font-black text-slate-800">0</h3>
                <div class="kpi-bar-bg"><div id="b_meet" class="kpi-bar-fill bg-cyan-500" style="width: 0%"></div></div>
                <div id="p_meet" class="mt-2 text-[10px] font-extrabold text-cyan-600">0% Achieved</div>
            </div>
        </section>

        <!-- Analytics & Top Rankings -->
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Chart Area -->
            <div class="lg:col-span-8 premium-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 tracking-tighter">Strategic Analytics</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Plan vs Achievement Gap Monitoring</p>
                    </div>
                    <div class="flex items-center gap-6 bg-slate-50 px-6 py-2.5 rounded-2xl border">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-600"></div><span class="text-[10px] font-black text-slate-500">ACTUAL</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-200"></div><span class="text-[10px] font-black text-slate-500">TARGET</span></div>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="mainChartCanvas"></canvas>
                </div>
            </div>

            <!-- Rankings Area -->
            <div class="lg:col-span-4 premium-card p-8 flex flex-col">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Top Performers</h2>
                    <i data-lucide="award" class="w-6 h-6 text-amber-500"></i>
                </div>
                <div id="leaderboardList" class="space-y-4 flex-1 overflow-y-auto pr-2 custom-scroll">
                    <!-- Dynamic Leaders -->
                </div>
            </div>
        </section>

        <!-- Detailed Matrix (High-Performance Table) -->
        <section class="premium-card overflow-hidden">
            <div class="p-8 border-b bg-slate-50/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-black text-slate-800 uppercase">Audit Matrix (Merged Data)</h2>
                    <p class="text-xs font-bold text-slate-400 uppercase mt-1 tracking-widest">प्रत्येक स्टाफचे टार्गेट आणि अचिव्हमेंटचे विलीनीकरण विश्लेषण</p>
                </div>
                <div id="rowCountDisplay" class="bg-slate-800 text-white px-5 py-2 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em]">
                    0 Records Processed
                </div>
            </div>
            <div class="overflow-x-auto max-h-[800px] overflow-y-auto custom-scroll">
                <table class="w-full text-left">
                    <thead class="bg-white sticky top-0 shadow-sm z-10">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="px-10 py-6">FX Staff Name & Branch</th>
                            <th class="px-6 py-6 text-center">Disbursement %</th>
                            <th class="px-6 py-6 text-center">Recovery %</th>
                            <th class="px-6 py-6 text-center">Rocket Pay</th>
                            <th class="px-6 py-6 text-center">Meetings</th>
                            <th class="px-6 py-6 text-center">Audit Status</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Global Loader Overlay -->
    <div id="globalLoader" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center transition-all duration-500">
        <div class="loading-ring mb-6"></div>
        <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Syncing HQ Intelligence</h2>
        <p id="loaderStatus" class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.5em] mt-3 animate-pulse">Initializing Data Merging Engine...</p>
    </div>

    <script>
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbxrsdH0yjhKLl6mQi7pnq6l__J3M3BZvmqseBxYDamv18zi6o8BfRcPcYIK06Boy6Ma/exec",
            REFRESH_INTERVAL: 600000 // 10 mins
        };

        let masterDataStore = [];
        let chartInstance = null;
        let globalAggregates = {};

        async function init() {
            lucide.createIcons();
            
            // Period Picker
            flatpickr("#globalDateRange", {
                mode: "range", dateFormat: "Y-m-d",
                defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
                onChange: () => processAndRender()
            });

            await fetchAllData();
        }

        async function fetchAllData() {
            const loader = document.getElementById('globalLoader');
            const status = document.getElementById('loaderStatus');
            loader.style.display = 'flex';
            loader.style.opacity = '1';

            try {
                status.innerText = "QUERYING AREA MANAGERS...";
                const mgrResp = await fetch(`${CONFIG.API_URL}?action=getManagers`);
                const mgrList = await mgrResp.json();

                // Update Manager Dropdown
                const mgrSelect = document.getElementById('mgrDropdown');
                mgrSelect.innerHTML = '<option value="all">सर्व मॅनेजर्स</option>';
                mgrList.forEach(m => mgrSelect.innerHTML += `<option value="${m}">${m}</option>`);

                status.innerText = "FETCHING 1000+ PERFORMANCE LAYERS...";
                let allRawRecords = [];

                // Parallel fetching for performance
                const fetchTasks = mgrList.map(async (mgr) => {
                    try {
                        const dResp = await fetch(`${CONFIG.API_URL}?action=getManagerData&manager=${encodeURIComponent(mgr)}`);
                        const result = await dResp.json();
                        result.history.forEach(week => {
                            week.details.forEach(item => {
                                allRawRecords.push({ ...item, mgr: mgr, sDate: week.sDate, eDate: week.eDate });
                            });
                        });
                    } catch (e) { console.warn(`Manager ${mgr} failed to sync.`); }
                });

                await Promise.all(fetchTasks);

                status.innerText = "MERGING TARGET & ACHIEVEMENT STREAMS...";
                
                // --- CRITICAL MERGING LOGIC ---
                const mergedMap = {};
                allRawRecords.forEach(item => {
                    const uniqueKey = `${item.mgr}_${item.name}_${item.sDate}`;
                    
                    if (!mergedMap[uniqueKey]) {
                        mergedMap[uniqueKey] = {
                            mgr: item.mgr,
                            rawName: item.name,
                            staff: item.name.split('||')[0].trim(),
                            kpiDesc: item.name.split('||')[1] ? item.name.split('||')[1].trim() : "General",
                            target: parseFloat(item.tDisb || 0),
                            achieved: 0,
                            sDate: item.sDate,
                            eDate: item.eDate,
                            remarks: item.pd || ""
                        };
                    }

                    // Achievement logic: जर aDisb 0 नसेल तर ते अचिव्हमेंट आहे
                    const valA = parseFloat(item.aDisb || 0);
                    if (valA > 0) {
                        mergedMap[uniqueKey].achieved = valA;
                    }
                    
                    // काहीवेळा target आणि achievement दोन्ही एकाच ओळीत येतात, तेही मॅप करा
                    if (parseFloat(item.tDisb || 0) > 0) {
                        mergedMap[uniqueKey].target = parseFloat(item.tDisb);
                    }
                });

                masterDataStore = Object.values(mergedMap);
                syncStaffDropdown();
                processAndRender();

            } catch (err) {
                Swal.fire("System Error", "HQ डेटाबेस सिंक करताना त्रुटी आली.", "error");
            } finally {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }

        function syncStaffDropdown() {
            const selectedMgr = document.getElementById('mgrDropdown').value;
            const staffSelect = document.getElementById('staffDropdown');
            staffSelect.innerHTML = '<option value="all">सर्व स्टाफ सदस्य</option>';

            const staffList = [...new Set(
                masterDataStore
                .filter(d => selectedMgr === 'all' || d.mgr === selectedMgr)
                .map(d => d.staff)
            )].sort();

            staffList.forEach(s => staffSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function processAndRender() {
            const mgr = document.getElementById('mgrDropdown').value;
            const staff = document.getElementById('staffDropdown').value;
            const search = document.getElementById('searchBox').value.toLowerCase();
            const dateRange = document.getElementById('globalDateRange').value;

            const filtered = masterDataStore.filter(d => {
                const matchM = (mgr === 'all' || d.mgr === mgr);
                const matchS = (staff === 'all' || d.staff === staff);
                const matchQ = d.staff.toLowerCase().includes(search) || d.kpiDesc.toLowerCase().includes(search);
                let matchD = true;
                if (dateRange.includes(' to ')) {
                    const [s, e] = dateRange.split(' to ');
                    matchD = (d.sDate >= s && d.sDate <= e);
                }
                return matchM && matchS && matchQ && matchD;
            });

            // Aggregate Calculations for 7 Pillars
            const buckets = {
                disb: {t:0, a:0}, appr: {t:0, a:0}, od: {t:0, a:0},
                reg: {t:0, a:0}, past: {t:0, a:0}, rock: {t:0, a:0}, meet: {t:0, a:0}
            };

            filtered.forEach(d => {
                const k = d.kpiDesc.toLowerCase();
                if (k.includes('disbursement')) { buckets.disb.t += d.target; buckets.disb.a += d.achieved; }
                else if (k.includes('appraisal') || k.includes('apprisal')) { buckets.appr.t += d.target; buckets.appr.a += d.achieved; }
                else if (k.includes('recovery')) { buckets.od.t += d.target; buckets.od.a += d.achieved; }
                else if (k.includes('regular')) { buckets.reg.t += d.target; buckets.reg.a += d.achieved; }
                else if (k.includes('past due')) { buckets.past.t += d.target; buckets.past.a += d.achieved; }
                else if (k.includes('rocket') || k.includes('auto pay')) { buckets.rock.t += d.target; buckets.rock.a += d.achieved; }
                else if (k.includes('meeting')) { buckets.meet.t += d.target; buckets.meet.a += d.achieved; }
            });

            globalAggregates = buckets;
            updateKPICards(buckets);
            updateLeaderboard(filtered);
            updateMatrixTable(filtered);
            updateMainChart(buckets);

            document.getElementById('rowCountDisplay').innerText = `${filtered.length} Records Processed`;
        }

        function updateKPICards(b) {
            const set = (id, data, isCurr) => {
                const p = data.t > 0 ? Math.round((data.a / data.t) * 100) : 0;
                document.getElementById(`v_${id}`).innerText = isCurr ? `₹ ${formatINR(data.a)}` : data.a;
                document.getElementById(`p_${id}`).innerText = `${p}% Achieved`;
                document.getElementById(`b_${id}`).style.width = `${Math.min(p, 100)}%`;
            };

            set('disb', b.disb, true);
            set('appr', b.appr, true);
            set('od', b.od, true);
            set('reg', b.reg, true);
            set('past', b.past, true);
            set('rock', b.rock, false);
            set('meet', b.meet, false);

            let totalA = 0, totalT = 0;
            Object.values(b).forEach(v => { totalA += v.a; totalT += v.t; });
            document.getElementById('overallAchv').innerText = (totalT > 0 ? Math.round((totalA/totalT)*100) : 0) + '%';
        }

        function updateLeaderboard(data) {
            const container = document.getElementById('leaderboardList');
            container.innerHTML = "";
            const stats = {};

            data.forEach(d => {
                if (!stats[d.staff]) stats[d.staff] = { n: d.staff, m: d.mgr, a: 0, t: 0 };
                stats[d.staff].a += d.achieved;
                stats[d.staff].t += d.target;
            });

            const sorted = Object.values(stats)
                .sort((a,b) => (b.a/b.t) - (a.a/a.t))
                .slice(0, 10);

            sorted.forEach((s, i) => {
                const p = s.t > 0 ? Math.round((s.a/s.t)*100) : 0;
                container.innerHTML += `
                    <div class="flex items-center justify-between p-5 bg-slate-50 rounded-3xl border border-slate-100 transition-all hover:bg-white hover:border-blue-200">
                        <div class="flex items-center gap-4">
                            <span class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-[10px] font-black">${i+1}</span>
                            <div>
                                <h4 class="font-black text-slate-800 text-sm leading-none">${s.n}</h4>
                                <p class="text-[9px] font-bold text-slate-400 uppercase mt-1.5 tracking-widest">${s.m}</p>
                            </div>
                        </div>
                        <span class="text-sm font-black text-blue-600">${p}%</span>
                    </div>
                `;
            });
        }

        function updateMatrixTable(data) {
            const body = document.getElementById('matrixTableBody');
            body.innerHTML = "";
            const groupMap = {};

            // Table grouping logic for merged view
            data.forEach(d => {
                const key = `${d.staff}_${d.sDate}`;
                if (!groupMap[key]) groupMap[key] = { n: d.staff, m: d.mgr, d: d.sDate, da:0, dt:0, ra:0, rt:0, rock:0, mt:0 };
                const k = d.kpiDesc.toLowerCase();
                if (k.includes('disbursement')) { groupMap[key].da += d.achieved; groupMap[key].dt += d.target; }
                if (k.includes('regular')) { groupMap[key].ra += d.achieved; groupMap[key].rt += d.target; }
                if (k.includes('rocket')) { groupMap[key].rock += d.achieved; }
                if (k.includes('meeting')) { groupMap[key].mt += d.achieved; }
            });

            Object.values(groupMap).forEach(r => {
                const dp = r.dt > 0 ? Math.round((r.da/r.dt)*100) : 0;
                const rp = r.rt > 0 ? Math.round((r.ra/r.rt)*100) : 0;
                const avg = (dp + rp) / 2;
                let bCls = "badge-average"; let status = "Moderate";
                if (avg >= 90) { bCls="badge-elite"; status="Elite"; }
                if (avg < 50) { bCls="badge-critical"; status="Critical"; }

                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-all group">
                        <td class="px-10 py-6">
                            <span class="font-black text-slate-700 text-sm group-hover:text-blue-600 transition-colors">${r.n}</span><br>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${r.m} | ${r.d}</span>
                        </td>
                        <td class="px-6 py-6 text-center font-bold text-slate-600">${dp}%</td>
                        <td class="px-6 py-6 text-center font-bold text-slate-600">${rp}%</td>
                        <td class="px-6 py-6 text-center font-black text-slate-700">${r.rock}</td>
                        <td class="px-6 py-6 text-center font-black text-slate-700">${r.mt}</td>
                        <td class="px-6 py-6 text-center"><span class="status-badge ${bCls}">${status}</span></td>
                    </tr>
                `;
            });
        }

        function updateMainChart(b) {
            const ctx = document.getElementById('mainChartCanvas').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Disb', 'Appr', 'OD Rec', 'Regular', 'Past Due', 'Rocket', 'Meetings'],
                    datasets: [
                        { label: 'Actual', data: [b.disb.a, b.appr.a, b.od.a, b.reg.a, b.past.a, b.rock.a, b.meet.a], backgroundColor: '#1e40af', borderRadius: 10, barThickness: 35 },
                        { label: 'Target', data: [b.disb.t, b.appr.t, b.od.t, b.reg.t, b.past.t, b.rock.t, b.meet.t], backgroundColor: '#e2e8f0', borderRadius: 10, barThickness: 35 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        function showKPIStats(id, label) {
            const d = globalAggregates[id];
            const p = d.t > 0 ? ((d.a/d.t)*100).toFixed(2) : 0;
            const sym = (id !== 'rock' && id !== 'meet') ? '₹ ' : '';

            Swal.fire({
                title: `<span class="uppercase font-black">${label} Analysis</span>`,
                html: `
                    <div class="text-left space-y-4 p-4">
                        <div class="flex justify-between border-b pb-2"><span class="text-slate-500 text-xs font-bold uppercase">Target:</span><span class="font-black text-slate-800">${sym}${formatINR(d.t)}</span></div>
                        <div class="flex justify-between border-b pb-2"><span class="text-slate-500 text-xs font-bold uppercase">Achieved:</span><span class="font-black text-emerald-600">${sym}${formatINR(d.a)}</span></div>
                        <div class="flex justify-between border-b pb-2"><span class="text-slate-500 text-xs font-bold uppercase">Gap:</span><span class="font-black text-rose-600">${sym}${formatINR(Math.max(0, d.t-d.a))}</span></div>
                        <div class="flex justify-between pt-2 text-xl"><span class="font-black">Ratio:</span><span class="font-black text-blue-600">${p}%</span></div>
                    </div>
                `,
                confirmButtonText: 'CLOSE MATRIX',
                confirmButtonColor: '#1e40af'
            });
        }

        function generateAuditReport() {
            const mgr = document.getElementById('mgrDropdown').value;
            const period = document.getElementById('globalDateRange').value;
            
            document.getElementById('p_mgr_name').innerText = mgr === 'all' ? 'All Area Managers' : mgr;
            document.getElementById('p_date_range').innerText = period || 'Current Period';
            document.getElementById('p_report_id').innerText = Math.floor(1000 + Math.random() * 9000);

            const printTBody = document.getElementById('print_table_body');
            printTBody.innerHTML = "";

            masterDataStore.forEach((d, i) => {
                const perc = d.target > 0 ? ((d.achieved/d.target)*100).toFixed(1) : 0;
                printTBody.innerHTML += `
                    <tr>
                        <td style="text-align:center;">${i+1}</td>
                        <td><b>${d.staff}</b><br><small style="color:#666">${d.mgr}</small></td>
                        <td>${d.kpiDesc}</td>
                        <td style="text-align:right;">${formatINR(d.target)}</td>
                        <td style="text-align:right;">${formatINR(d.achieved)}</td>
                        <td style="text-align:center; font-weight:bold;">${perc}%</td>
                    </tr>
                `;
            });

            if(masterDataStore.length === 0) {
                Swal.fire("Data Missing", "प्रिंट करण्यासाठी कोणताही डेटा उपलब्ध नाही.", "warning");
            } else {
                window.print();
            }
        }

        function formatINR(val) {
            return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(val);
        }

        window.onload = init;
    </script>
</body>
</html>
