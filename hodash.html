<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Fin | HO Enterprise Strategy Command Center</title>

    <!-- UI Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #1e40af;
            --secondary: #0f172a;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --bg-slate: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-slate);
            color: #1e293b;
            letter-spacing: -0.02em;
        }

        /* Premium Glass Design */
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .hq-card {
            background: white;
            border-radius: 28px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hq-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 30px -10px rgba(0, 0, 0, 0.06);
            border-color: var(--primary);
        }

        .kpi-indicator {
            height: 6px;
            border-radius: 10px;
            background: #e2e8f0;
            overflow: hidden;
        }

        .kpi-indicator-fill {
            height: 100%;
            transition: width 1s ease-out;
        }

        /* Custom Scrollbar for 1000+ Lines */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Professional Audit Badges */
        .status-badge {
            padding: 5px 14px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-elite { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .status-avg { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
        .status-low { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        /* Print Formatting (A4 Optimization) */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none !important; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 10px; text-align: left; font-size: 11px; }
            .print-header { text-align: center; border-bottom: 3px solid #1e40af; padding-bottom: 20px; }
        }
        #printArea { display: none; }
    </style>
</head>
<body class="custom-scroll">

    <!-- 1. AUDIT PRINT TEMPLATE -->
    <div id="printArea">
        <div class="print-header">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" style="height: 50px;">
            <h1 style="font-size: 24px; font-weight: 800; color: #1e40af; margin-top: 10px;">ANIK FINANCIAL SERVICES PVT LTD</h1>
            <p style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #444;">Monthly Strategy Achievement & Audit Matrix</p>
        </div>
        <div style="margin-top: 20px; display: flex; justify-content: space-between; font-size: 12px; font-weight: bold;">
            <span>Manager: <span id="pr_mgr">-</span></span>
            <span>Generated Date: <span id="pr_date">-</span></span>
        </div>
        <table class="print-table">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th>#</th>
                    <th>Staff Name</th>
                    <th>KPI Details</th>
                    <th>Target</th>
                    <th>Achieved</th>
                    <th>Gap</th>
                    <th>Achv. %</th>
                </tr>
            </thead>
            <tbody id="print_table_rows"></tbody>
        </table>
        <div style="margin-top: 100px; display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 200px; border-top: 1.5px solid #000; padding-top: 5px; font-weight: bold;">Area Manager Signature</div>
            <div style="text-align: center; width: 200px; border-top: 1.5px solid #000; padding-top: 5px; font-weight: bold;">HO Strategy Auditor</div>
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD UI -->
    <nav class="glass-nav sticky top-0 z-[100] h-20 no-print">
        <div class="max-w-[1750px] mx-auto px-8 h-full flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="bg-blue-600 p-2.5 rounded-2xl shadow-lg shadow-blue-200">
                    <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-5 brightness-0 invert">
                </div>
                <div class="h-10 w-[1.5px] bg-slate-200"></div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 tracking-tighter uppercase">Command Center</h1>
                    <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Live Strategy Achievement Matrix</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 bg-slate-100 border px-4 py-2.5 rounded-2xl">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                    <input type="text" id="dateRange" class="bg-transparent text-sm font-bold outline-none w-48" placeholder="Select Period">
                </div>
                <button onclick="fetchAllData()" class="bg-slate-800 hover:bg-black text-white px-6 py-2.5 rounded-2xl font-bold text-xs flex items-center gap-3 transition-all">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> रिफ्रेश डेटा
                </button>
                <button onclick="generateAuditReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-7 py-2.5 rounded-2xl font-bold text-xs shadow-xl shadow-blue-100 flex items-center gap-3 transition-all">
                    <i data-lucide="printer" class="w-4 h-4"></i> ऑडिट रिपोर्ट प्रिंट
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1750px] mx-auto p-8 space-y-8 no-print">

        <!-- Top Statistics & Filters -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div class="md:col-span-3 hq-card p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">मॅनेजर निवडा</label>
                    <select id="mgrFilter" onchange="syncStaffDropdown()" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl font-bold text-slate-700 outline-none focus:ring-4 ring-blue-500/10">
                        <option value="all">सर्व मॅनेजर्स</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">स्टाफ निवडा</label>
                    <select id="staffFilter" onchange="processAndRender()" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl font-bold text-slate-700 outline-none focus:ring-4 ring-blue-500/10">
                        <option value="all">सर्व स्टाफ सदस्य</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">नाव शोधा</label>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="searchTerm" oninput="processAndRender()" placeholder="नाव टाईप करा..." class="w-full bg-slate-50 border border-slate-100 p-4 pl-12 rounded-2xl font-bold text-slate-700 outline-none">
                    </div>
                </div>
            </div>

            <div class="hq-card p-8 bg-gradient-to-br from-blue-700 to-indigo-900 border-none flex flex-col justify-center items-center text-white relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 opacity-10"><i data-lucide="award" class="w-32 h-32"></i></div>
                <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2 z-10">Total Efficiency</p>
                <h2 id="overallPerc" class="text-6xl font-black z-10 tracking-tighter">0%</h2>
                <div id="overallTrend" class="mt-4 text-[10px] font-bold bg-white/10 px-4 py-1.5 rounded-full z-10">ANALYZING TREND...</div>
            </div>
        </section>

        <!-- KPI Power Grid (7 Key Indicators) -->
        <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6">
            <!-- Disb -->
            <div onclick="showDetailedKPIData('disb', 'Disbursement')" class="hq-card p-6 border-b-4 border-b-blue-600 cursor-pointer">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Disbursement</p>
                <h3 id="v_disb" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-indicator mt-4"><div id="b_disb" class="kpi-indicator-fill bg-blue-600" style="width: 0%"></div></div>
                <div id="p_disb" class="mt-2 text-[10px] font-black text-blue-600">0% ACHIEVED</div>
            </div>

            <!-- Appr -->
            <div onclick="showDetailedKPIData('appr', 'Appraisal')" class="hq-card p-6 border-b-4 border-b-indigo-500 cursor-pointer">
                <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="file-check" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Appraisal</p>
                <h3 id="v_appr" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-indicator mt-4"><div id="b_appr" class="kpi-indicator-fill bg-indigo-600" style="width: 0%"></div></div>
                <div id="p_appr" class="mt-2 text-[10px] font-black text-indigo-600">0% ACHIEVED</div>
            </div>

            <!-- OD -->
            <div onclick="showDetailedKPIData('od', 'OD Recovery')" class="hq-card p-6 border-b-4 border-b-rose-600 cursor-pointer">
                <div class="w-10 h-10 bg-rose-50 text-rose-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="alert-triangle" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">OD Recovery</p>
                <h3 id="v_od" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-indicator mt-4"><div id="b_od" class="kpi-indicator-fill bg-rose-600" style="width: 0%"></div></div>
                <div id="p_od" class="mt-2 text-[10px] font-black text-rose-600">0% ACHIEVED</div>
            </div>

            <!-- Reg -->
            <div onclick="showDetailedKPIData('reg', 'Regular Coll.')" class="hq-card p-6 border-b-4 border-b-emerald-600 cursor-pointer">
                <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="check-circle" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Regular Coll.</p>
                <h3 id="v_reg" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-indicator mt-4"><div id="b_reg" class="kpi-indicator-fill bg-emerald-600" style="width: 0%"></div></div>
                <div id="p_reg" class="mt-2 text-[10px] font-black text-emerald-600">0% ACHIEVED</div>
            </div>

            <!-- Past -->
            <div onclick="showDetailedKPIData('past', 'Past Due')" class="hq-card p-6 border-b-4 border-b-amber-600 cursor-pointer">
                <div class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="history" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Past Due</p>
                <h3 id="v_past" class="text-lg font-black text-slate-800">₹ 0</h3>
                <div class="kpi-indicator mt-4"><div id="b_past" class="kpi-indicator-fill bg-amber-600" style="width: 0%"></div></div>
                <div id="p_past" class="mt-2 text-[10px] font-black text-amber-600">0% ACHIEVED</div>
            </div>

            <!-- Rock -->
            <div onclick="showDetailedKPIData('rock', 'Rocket Pay')" class="hq-card p-6 border-b-4 border-b-purple-600 cursor-pointer">
                <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="rocket" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Rocket Pay</p>
                <h3 id="v_rock" class="text-lg font-black text-slate-800">0</h3>
                <div class="kpi-indicator mt-4"><div id="b_rock" class="kpi-indicator-fill bg-purple-600" style="width: 0%"></div></div>
                <div id="p_rock" class="mt-2 text-[10px] font-black text-purple-600">0% ACHIEVED</div>
            </div>

            <!-- Meet -->
            <div onclick="showDetailedKPIData('meet', 'Meetings')" class="hq-card p-6 border-b-4 border-b-cyan-600 cursor-pointer">
                <div class="w-10 h-10 bg-cyan-50 text-cyan-600 rounded-xl flex items-center justify-center mb-4"><i data-lucide="users" class="w-5 h-5"></i></div>
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Meetings</p>
                <h3 id="v_meet" class="text-lg font-black text-slate-800">0</h3>
                <div class="kpi-indicator mt-4"><div id="b_meet" class="kpi-indicator-fill bg-cyan-600" style="width: 0%"></div></div>
                <div id="p_meet" class="mt-2 text-[10px] font-black text-cyan-600">0% ACHIEVED</div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Main Chart -->
            <div class="lg:col-span-8 hq-card p-8">
                <div class="flex justify-between items-center mb-10">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800">Strategy Performance Ratio</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Target vs Achievement Gap Intelligence</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-blue-600"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Actual</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-slate-200"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Target</span></div>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>

            <!-- Top Performance Ranking -->
            <div class="lg:col-span-4 hq-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black text-slate-800 uppercase">Top 10 Leaders</h2>
                    <i data-lucide="trophy" class="w-6 h-6 text-amber-500"></i>
                </div>
                <div id="rankingsList" class="space-y-4 max-h-[420px] overflow-y-auto pr-2 custom-scroll">
                    <!-- Leaderboard Rows -->
                </div>
            </div>
        </section>

        <!-- Detailed Matrix (1000+ Lines Capacity) -->
        <section class="hq-card overflow-hidden">
            <div class="p-8 bg-slate-50/50 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-black text-slate-800 uppercase">Detailed Audit Matrix</h2>
                    <p class="text-xs font-bold text-slate-400 mt-1 uppercase">प्रत्येक स्टाफचे कालावधीनुसार सविस्तर विश्लेषण</p>
                </div>
                <div id="recordInfo" class="bg-slate-800 text-white px-5 py-2 rounded-2xl text-[10px] font-black uppercase tracking-widest">
                    0 Records Filtered
                </div>
            </div>
            <div class="overflow-x-auto max-h-[800px] overflow-y-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white sticky top-0 z-10 shadow-sm">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-[0.1em]">
                            <th class="px-10 py-6">FX Staff Name & Branch</th>
                            <th class="px-6 py-6 text-center">Disbursement %</th>
                            <th class="px-6 py-6 text-center">Recovery %</th>
                            <th class="px-6 py-6 text-center">Rocket Pay</th>
                            <th class="px-6 py-6 text-center">Group Meeting</th>
                            <th class="px-6 py-6 text-center">Audit Status</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody" class="divide-y divide-slate-100">
                        <!-- Matrix Rows -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Initial Loading Overlay -->
    <div id="loaderOverlay" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <div class="mt-8 text-center">
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase">Anik Intelligence System</h2>
            <p id="loaderStatus" class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.5em] mt-4 animate-pulse">Syncing Enterprise Database...</p>
        </div>
    </div>

    <script>
        // HO API Configuration
        const API_URL = "https://script.google.com/macros/s/AKfycbxrsdH0yjhKLl6mQi7pnq6l__J3M3BZvmqseBxYDamv18zi6o8BfRcPcYIK06Boy6Ma/exec";
        
        // State Management for 1000+ Lines
        let masterStore = [];
        let filteredStore = [];
        let mainChart = null;
        let globalAggregates = {};

        async function init() {
            lucide.createIcons();
            
            // Period Initializer
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
                onChange: () => processAndRender()
            });

            await fetchAllData();
        }

        async function fetchAllData() {
            document.getElementById('loaderOverlay').style.display = 'flex';
            document.getElementById('loaderStatus').innerText = "QUERYING HQ MANAGERS...";

            try {
                // Fetch Managers First
                const mResp = await fetch(`${API_URL}?action=getManagers`);
                const managers = await mResp.json();
                
                const mgrSelect = document.getElementById('mgrFilter');
                mgrSelect.innerHTML = '<option value="all">सर्व मॅनेजर्स</option>';
                managers.forEach(m => mgrSelect.innerHTML += `<option value="${m}">${m}</option>`);

                document.getElementById('loaderStatus').innerText = "FETCHING 1000+ LINE KPI DATA...";
                masterStore = [];

                // Parallel Fetching for Efficiency
                const fetchPromises = managers.map(async (mgr) => {
                    try {
                        const dResp = await fetch(`${API_URL}?action=getManagerData&manager=${encodeURIComponent(mgr)}`);
                        const data = await dResp.json();
                        
                        data.history.forEach(week => {
                            week.details.forEach(item => {
                                // Smart Parser: "Name || KPI Description"
                                const rawName = item.name || "Unknown";
                                let staff = rawName;
                                let kpi = "General";
                                
                                if (rawName.includes('||')) {
                                    const parts = rawName.split('||');
                                    staff = parts[0].trim();
                                    kpi = parts[1].trim();
                                }

                                masterStore.push({
                                    mgr: mgr,
                                    staff: staff,
                                    kpi: kpi,
                                    target: parseFloat(item.tDisb || item.tAppr || item.tOD || item.tReg || item.tPast || item.tRocket || item.tGroup || 0),
                                    achieved: parseFloat(item.aDisb || item.aAppr || item.aOD || item.aReg || item.aPast || item.aRocket || item.aGroup || 0),
                                    sDate: week.sDate,
                                    eDate: week.eDate,
                                    remarks: item.pd || "-"
                                });
                            });
                        });
                    } catch (err) { console.error(`Manager ${mgr} Fail:`, err); }
                });

                await Promise.all(fetchPromises);
                syncStaffDropdown();
                processAndRender();

            } catch (error) {
                Swal.fire("Connection Error", "HQ डेटाबेसशी संपर्क होऊ शकला नाही.", "error");
            } finally {
                document.getElementById('loaderOverlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loaderOverlay').style.display = 'none', 700);
            }
        }

        function syncStaffDropdown() {
            const selectedMgr = document.getElementById('mgrFilter').value;
            const staffFilter = document.getElementById('staffFilter');
            staffFilter.innerHTML = '<option value="all">सर्व स्टाफ सदस्य</option>';

            const staffList = [...new Set(
                masterStore
                .filter(d => selectedMgr === 'all' || d.mgr === selectedMgr)
                .map(d => d.staff)
            )].sort();

            staffList.forEach(s => staffFilter.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function processAndRender() {
            const mgr = document.getElementById('mgrFilter').value;
            const staff = document.getElementById('staffFilter').value;
            const search = document.getElementById('searchTerm').value.toLowerCase();
            const dateVal = document.getElementById('dateRange').value;

            filteredStore = masterStore.filter(d => {
                const matchM = (mgr === 'all' || d.mgr === mgr);
                const matchS = (staff === 'all' || d.staff === staff);
                const matchQ = d.staff.toLowerCase().includes(search);
                let matchD = true;
                if (dateVal.includes(' to ')) {
                    const [s, e] = dateVal.split(' to ');
                    matchD = (d.sDate >= s && d.sDate <= e);
                }
                return matchM && matchS && matchQ && matchD;
            });

            // Aggregate Calculations for 7 KPIs
            const buckets = {
                disb: {t:0, a:0}, appr: {t:0, a:0}, od: {t:0, a:0},
                reg: {t:0, a:0}, past: {t:0, a:0}, rock: {t:0, a:0}, meet: {t:0, a:0}
            };

            filteredStore.forEach(d => {
                const k = d.kpi.toLowerCase();
                if(k.includes('disbursement')) { buckets.disb.t += d.target; buckets.disb.a += d.achieved; }
                else if(k.includes('appraisal') || k.includes('apprisal')) { buckets.appr.t += d.target; buckets.appr.a += d.achieved; }
                else if(k.includes('od recovery') || k.includes('recovery')) { buckets.od.t += d.target; buckets.od.a += d.achieved; }
                else if(k.includes('regular collection')) { buckets.reg.t += d.target; buckets.reg.a += d.achieved; }
                else if(k.includes('past due')) { buckets.past.t += d.target; buckets.past.a += d.achieved; }
                else if(k.includes('rocket pay') || k.includes('auto pay')) { buckets.rock.t += d.target; buckets.rock.a += d.achieved; }
                else if(k.includes('group meeting') || k.includes('meeting')) { buckets.meet.t += d.target; buckets.meet.a += d.achieved; }
            });

            globalAggregates = buckets;
            renderKPIBoxes(buckets);
            renderMainChart(buckets);
            renderLeaderboard(filteredStore);
            renderMatrixTable(filteredStore);
            
            document.getElementById('recordInfo').innerText = `${filteredStore.length} Records Found`;
        }

        function renderKPIBoxes(b) {
            const updateUI = (id, data, isCurrency) => {
                const p = data.t > 0 ? Math.round((data.a / data.t) * 100) : 0;
                document.getElementById(`v_${id}`).innerText = isCurrency ? `₹ ${formatINR(data.a)}` : data.a;
                document.getElementById(`p_${id}`).innerText = `${p}% ACHIEVED`;
                document.getElementById(`b_${id}`).style.width = `${Math.min(p, 100)}%`;
            };

            updateUI('disb', b.disb, true);
            updateUI('appr', b.appr, true);
            updateUI('od', b.od, true);
            updateUI('reg', b.reg, true);
            updateUI('past', b.past, true);
            updateUI('rock', b.rock, false);
            updateUI('meet', b.meet, false);

            let totalA = 0, totalT = 0;
            Object.values(b).forEach(v => { totalA += v.a; totalT += v.t; });
            const finalPerc = totalT > 0 ? Math.round((totalA/totalT)*100) : 0;
            document.getElementById('overallPerc').innerText = `${finalPerc}%`;
            
            const trend = document.getElementById('overallTrend');
            if(finalPerc >= 90) { trend.innerText = "EXCELLENT EXECUTION"; trend.style.color = "#4ade80"; }
            else if(finalPerc >= 70) { trend.innerText = "STEADY GROWTH"; trend.style.color = "#fbbf24"; }
            else { trend.innerText = "ATTENTION REQUIRED"; trend.style.color = "#f87171"; }
        }

        function renderMainChart(b) {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            if(mainChart) mainChart.destroy();

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Disb', 'Appr', 'Recovery', 'Regular', 'Past Due', 'Rocket', 'Meetings'],
                    datasets: [
                        { label: 'Actual', data: [b.disb.a, b.appr.a, b.od.a, b.reg.a, b.past.a, b.rock.a, b.meet.a], backgroundColor: '#1e40af', borderRadius: 8, barThickness: 40 },
                        { label: 'Target', data: [b.disb.t, b.appr.t, b.od.t, b.reg.t, b.past.t, b.rock.t, b.meet.t], backgroundColor: '#e2e8f0', borderRadius: 8, barThickness: 40 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderLeaderboard(data) {
            const container = document.getElementById('rankingsList');
            container.innerHTML = "";
            const stats = {};

            data.forEach(d => {
                if(!stats[d.staff]) stats[d.staff] = { n: d.staff, m: d.mgr, a: 0, t: 0 };
                stats[d.staff].a += d.achieved;
                stats[d.staff].t += d.target;
            });

            const sorted = Object.values(stats)
                .sort((a,b) => (b.a/b.t) - (a.a/a.t))
                .slice(0, 10);

            sorted.forEach((s, idx) => {
                const perc = s.t > 0 ? Math.round((s.a/s.t)*100) : 0;
                container.innerHTML += `
                    <div class="flex items-center justify-between p-5 bg-slate-50 rounded-3xl border border-slate-100 transition-all hover:bg-white hover:border-blue-200">
                        <div class="flex items-center gap-4">
                            <span class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-[10px] font-black">${idx+1}</span>
                            <div>
                                <h4 class="font-black text-slate-800 text-sm leading-none">${s.n}</h4>
                                <p class="text-[9px] font-bold text-slate-400 uppercase mt-1.5 tracking-widest">${s.m}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-black text-blue-600">${perc}%</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderMatrixTable(data) {
            const body = document.getElementById('matrixTableBody');
            body.innerHTML = "";
            const staffHistory = {};

            // Grouping for 1000+ line matrix view
            data.forEach(d => {
                const key = `${d.staff}_${d.sDate}`;
                if(!staffHistory[key]) staffHistory[key] = { n: d.staff, m: d.mgr, d: d.sDate, da:0, dt:0, ra:0, rt:0, rock:0, mt:0 };
                const k = d.kpi.toLowerCase();
                if(k.includes('disbursement')) { staffHistory[key].da += d.achieved; staffHistory[key].dt += d.target; }
                if(k.includes('regular collection')) { staffHistory[key].ra += d.achieved; staffHistory[key].rt += d.target; }
                if(k.includes('rocket')) { staffHistory[key].rock += d.achieved; }
                if(k.includes('meeting')) { staffHistory[key].mt += d.achieved; }
            });

            Object.values(staffHistory).forEach(r => {
                const dp = r.dt > 0 ? Math.round((r.da/r.dt)*100) : 0;
                const rp = r.rt > 0 ? Math.round((r.ra/r.rt)*100) : 0;
                const avg = (dp + rp) / 2;
                
                let bCls = "status-avg"; let status = "MODERATE";
                if(avg >= 90) { bCls="status-elite"; status="ELITE"; }
                if(avg < 50) { bCls="status-low"; status="CRITICAL"; }

                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-all">
                        <td class="px-10 py-6">
                            <span class="font-black text-slate-700 text-sm">${r.n}</span><br>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${r.m} | ${r.d}</span>
                        </td>
                        <td class="px-6 py-6 text-center font-bold text-slate-600">${dp}%</td>
                        <td class="px-6 py-6 text-center font-bold text-slate-600">${rp}%</td>
                        <td class="px-6 py-6 text-center font-black text-slate-700">${r.rock}</td>
                        <td class="px-6 py-6 text-center font-black text-slate-700">${r.mt}</td>
                        <td class="px-6 py-6 text-center"><span class="status-badge ${bCls}">${status}</span></td>
                    </tr>
                `;
            });
        }

        function showDetailedKPIData(id, label) {
            const d = globalAggregates[id];
            if(!d) return;
            const p = d.t > 0 ? ((d.a / d.t) * 100).toFixed(2) : 0;
            const sym = (id !== 'rock' && id !== 'meet') ? '₹ ' : '';

            Swal.fire({
                title: `<span class="uppercase font-black">${label} Intelligence</span>`,
                html: `
                    <div class="text-left space-y-4 p-4 font-bold text-slate-700">
                        <div class="flex justify-between border-b pb-2"><span>Planned Target:</span> <span>${sym}${formatINR(d.t)}</span></div>
                        <div class="flex justify-between border-b pb-2 text-emerald-600"><span>Actual Achieved:</span> <span>${sym}${formatINR(d.a)}</span></div>
                        <div class="flex justify-between border-b pb-2 text-rose-600"><span>Gap Pending:</span> <span>${sym}${formatINR(Math.max(0, d.t-d.a))}</span></div>
                        <div class="flex justify-between pt-2 text-xl font-black"><span>Performance:</span> <span class="text-blue-600">${p}%</span></div>
                    </div>
                `,
                confirmButtonText: 'CLOSE MATRIX',
                confirmButtonColor: '#1e40af'
            });
        }

        function generateAuditReport() {
            const mgr = document.getElementById('mgrFilter').value;
            const pBody = document.getElementById('print_table_rows');
            pBody.innerHTML = "";

            document.getElementById('pr_mgr').innerText = mgr === 'all' ? 'All Area Managers' : mgr;
            document.getElementById('pr_date').innerText = new Date().toLocaleDateString('en-IN', {dateStyle:'full'});

            filteredStore.forEach((d, i) => {
                const perc = d.target > 0 ? ((d.achieved/d.target)*100).toFixed(1) : 0;
                pBody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td><b>${d.staff}</b><br><small>${d.mgr}</small></td>
                        <td>${d.kpi}</td>
                        <td>${formatINR(d.target)}</td>
                        <td>${formatINR(d.achieved)}</td>
                        <td>${formatINR(Math.max(0, d.target-d.achieved))}</td>
                        <td style="font-weight:bold; color:${perc >= 90 ? 'green' : (perc < 50 ? 'red' : 'black')}">${perc}%</td>
                    </tr>
                `;
            });

            if(filteredStore.length === 0) {
                Swal.fire("Data Empty", "प्रिंट करण्यासाठी डेटा उपलब्ध नाही.", "warning");
            } else {
                window.print();
            }
        }

        function formatINR(val) {
            return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(val);
        }

        window.onload = init;
    </script>
</body>
</html>
