<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik HO Master Dashboard | Professional Analytics</title>

    <!-- UI Core -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f0f4f8; 
            color: #1e293b;
            letter-spacing: -0.02em;
        }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .stat-card { 
            background: white; 
            border-radius: 24px; 
            padding: 24px; 
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.05); }
        .kpi-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; }
        .efficiency-badge { padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 700; }
        .bg-success-soft { background: #dcfce7; color: #15803d; }
        .bg-warning-soft { background: #fef3c7; color: #b45309; }
        .bg-danger-soft { background: #fee2e2; color: #b91c1c; }
        
        select, input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="custom-scrollbar">

    <!-- Top Navigation -->
    <nav class="glass-header sticky top-0 z-[100] border-b border-slate-200">
        <div class="max-w-[1600px] mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-xl">
                    <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-6 brightness-0 invert" alt="Anik Logo">
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 leading-tight">HO COMMAND CENTER</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Live Performance Matrix</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div id="dateRangeContainer" class="hidden md:flex items-center bg-slate-100 border border-slate-200 rounded-xl px-4 py-2 cursor-pointer">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-500 mr-2"></i>
                    <input type="text" id="dateRange" class="bg-transparent border-none outline-none text-sm font-bold text-slate-700 w-48 pointer-events-none" placeholder="कालावधी निवडा">
                </div>
                <button onclick="fetchAllData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-blue-200 flex items-center gap-2 transition-all active:scale-95">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> रिफ्रेश
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto p-6 space-y-8">
        
        <!-- Selection & Filter Section -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
            <div class="space-y-2">
                <label class="kpi-label ml-1">मॅनेजर फिल्टर</label>
                <div class="relative">
                    <i data-lucide="users" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <select id="mgrFilter" onchange="updateStaffDropdown()" class="w-full bg-slate-50 border border-slate-200 pl-12 pr-4 py-3.5 rounded-2xl font-bold text-slate-700 focus:ring-2 ring-blue-500/20 outline-none transition-all">
                        <option value="all">सर्व मॅनेजर</option>
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <label class="kpi-label ml-1">स्टाफ निवडा (फक्त नाव)</label>
                <div class="relative">
                    <i data-lucide="user-check" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <select id="staffFilter" onchange="renderDashboard()" class="w-full bg-slate-50 border border-slate-200 pl-12 pr-4 py-3.5 rounded-2xl font-bold text-slate-700 focus:ring-2 ring-blue-500/20 outline-none transition-all">
                        <option value="all">सर्व स्टाफ</option>
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <label class="kpi-label ml-1">नाव शोधा</label>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="searchTerm" oninput="renderDashboard()" placeholder="स्टाफचे नाव टाईप करा..." class="w-full bg-slate-50 border border-slate-200 pl-12 pr-4 py-3.5 rounded-2xl font-bold text-slate-700 focus:ring-2 ring-blue-500/20 outline-none transition-all">
                </div>
            </div>
        </section>

        <!-- KPI Scoreboard -->
        <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
            <!-- Disb -->
            <div class="stat-card border-l-4 border-l-blue-600">
                <p class="kpi-label">Disbursement</p>
                <h3 id="valDisb" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percDisb" class="mt-2 text-[11px] font-bold text-blue-600 bg-blue-50 inline-block px-2 py-0.5 rounded">0% Achieved</div>
            </div>
            <!-- Appr -->
            <div class="stat-card border-l-4 border-l-indigo-500">
                <p class="kpi-label">Appraisal</p>
                <h3 id="valAppr" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percAppr" class="mt-2 text-[11px] font-bold text-indigo-600 bg-indigo-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
            <!-- Recovery -->
            <div class="stat-card border-l-4 border-l-rose-500">
                <p class="kpi-label">OD Recovery</p>
                <h3 id="valOD" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percOD" class="mt-2 text-[11px] font-bold text-rose-600 bg-rose-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
            <!-- Regular -->
            <div class="stat-card border-l-4 border-l-emerald-500">
                <p class="kpi-label">Regular Coll.</p>
                <h3 id="valReg" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percReg" class="mt-2 text-[11px] font-bold text-emerald-600 bg-emerald-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
            <!-- Past Due -->
            <div class="stat-card border-l-4 border-l-amber-500">
                <p class="kpi-label">Past Due</p>
                <h3 id="valPast" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percPast" class="mt-2 text-[11px] font-bold text-amber-600 bg-amber-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
            <!-- Rocket -->
            <div class="stat-card border-l-4 border-l-purple-500">
                <p class="kpi-label">Rocket Pay</p>
                <h3 id="valRocket" class="text-xl font-black text-slate-800 mt-1">₹ 0</h3>
                <div id="percRocket" class="mt-2 text-[11px] font-bold text-purple-600 bg-purple-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
            <!-- Meetings -->
            <div class="stat-card border-l-4 border-l-cyan-500">
                <p class="kpi-label">Group Meet</p>
                <h3 id="valMeet" class="text-xl font-black text-slate-800 mt-1">0</h3>
                <div id="percMeet" class="mt-2 text-[11px] font-bold text-cyan-600 bg-cyan-50 inline-block px-2 py-0.5 rounded">0%</div>
            </div>
        </section>

        <!-- Charts & Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-xl font-black text-slate-800">Target vs Actual Performance</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase mt-1">७ मुख्य KPIs मधील प्रगती</p>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="perfChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <h2 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-tight">Top Rankers</h2>
                <div id="rankList" class="space-y-4 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Ranks -->
                </div>
            </div>
        </div>

        <!-- Audit Table -->
        <section class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-800">DETAILED AUDIT LOG</h2>
                <div id="rowCounter" class="text-[10px] font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-full uppercase tracking-widest">0 Records Found</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <tr>
                            <th class="px-8 py-4">स्टाफ तपशील</th>
                            <th class="px-6 py-4">Disbursement (Ach.)</th>
                            <th class="px-6 py-4">Collection (Ach.)</th>
                            <th class="px-6 py-4">Rocket Pay</th>
                            <th class="px-6 py-4 text-center">Efficiency Status</th>
                        </tr>
                    </thead>
                    <tbody id="auditTable" class="divide-y divide-slate-100">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Syncing Screen -->
    <div id="syncLoader" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[200] flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
            <i data-lucide="database" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-blue-600 w-6 h-6"></i>
        </div>
        <h2 class="text-2xl font-black text-slate-800 mt-6 tracking-tighter">ANIK INTELLIGENCE SYNC</h2>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.4em] mt-2">Connecting to Master Data...</p>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrsdH0yjhKLl6mQi7pnq6l__J3M3BZvmqseBxYDamv18zi6o8BfRcPcYIK06Boy6Ma/exec";
        
        let database = [];
        let chartInstance = null;

        // 1. Initial Load
        async function init() {
            lucide.createIcons();
            
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
                onClose: () => renderDashboard()
            });

            await fetchAllData();
        }

        // 2. Data Fetching & Aggregation Logic
        async function fetchAllData() {
            document.getElementById('syncLoader').classList.remove('hidden');
            try {
                const mgrResp = await fetch(`${SCRIPT_URL}?action=getManagers`);
                const managers = await mgrResp.json();
                
                // Set Managers Dropdown
                const mgrSelect = document.getElementById('mgrFilter');
                mgrSelect.innerHTML = '<option value="all">सर्व मॅनेजर</option>';
                managers.forEach(m => mgrSelect.innerHTML += `<option value="${m}">${m}</option>`);

                database = [];
                const promises = managers.map(async (mgr) => {
                    const resp = await fetch(`${SCRIPT_URL}?action=getManagerData&manager=${encodeURIComponent(mgr)}`);
                    const json = await resp.json();
                    
                    json.history.forEach(week => {
                        week.details.forEach(item => {
                            // !!! CRITICAL FIX: Parsing the staff name to remove KPI labels !!!
                            const rawName = item.name || "";
                            const cleanName = rawName.split(' || ')[0].trim();
                            const kpiType = rawName.includes('||') ? rawName.split(' || ')[1] : "Unknown";

                            database.push({
                                mgr: mgr,
                                staff: cleanName,
                                kpiType: kpiType,
                                target: parseFloat(item.tDisb || item.tAppr || item.tOD || item.tReg || item.tPast || item.tRocket || item.tGroup || 0),
                                actual: parseFloat(item.aDisb || item.aAppr || item.aOD || item.aReg || item.aPast || item.aRocket || item.aGroup || 0),
                                sDate: week.sDate,
                                eDate: week.eDate
                            });
                        });
                    });
                });

                await Promise.all(promises);
                updateStaffDropdown();
                renderDashboard();

            } catch (err) {
                console.error(err);
                Swal.fire("Sync Failed", "डेटाबेसशी संपर्क होऊ शकला नाही.", "error");
            } finally {
                document.getElementById('syncLoader').classList.add('hidden');
            }
        }

        // 3. Update Staff Dropdown based on Manager
        function updateStaffDropdown() {
            const selectedMgr = document.getElementById('mgrFilter').value;
            const staffSelect = document.getElementById('staffFilter');
            staffSelect.innerHTML = '<option value="all">सर्व स्टाफ</option>';

            const staffList = [...new Set(
                database
                .filter(d => selectedMgr === 'all' || d.mgr === selectedMgr)
                .map(d => d.staff)
            )].sort();

            staffList.forEach(s => {
                if(s) staffSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });
            renderDashboard();
        }

        // 4. Dashboard Engine
        function renderDashboard() {
            const mgr = document.getElementById('mgrFilter').value;
            const staff = document.getElementById('staffFilter').value;
            const search = document.getElementById('searchTerm').value.toLowerCase();
            const dateStr = document.getElementById('dateRange').value;

            // Date Range Filter
            let filtered = database.filter(d => {
                const matchMgr = mgr === 'all' || d.mgr === mgr;
                const matchStaff = staff === 'all' || d.staff === staff;
                const matchSearch = d.staff.toLowerCase().includes(search);
                
                let matchDate = true;
                if(dateStr.includes(' to ')) {
                    const [s, e] = dateStr.split(' to ');
                    matchDate = (d.sDate >= s && d.sDate <= e);
                }
                return matchMgr && matchStaff && matchSearch && matchDate;
            });

            // Aggregate Data for KPIs
            const kpiSummary = {
                disb: {t:0, a:0}, appr: {t:0, a:0}, od: {t:0, a:0},
                reg: {t:0, a:0}, past: {t:0, a:0}, rocket: {t:0, a:0}, meet: {t:0, a:0}
            };

            filtered.forEach(d => {
                if(d.kpiType.includes('Disbursement')) { kpiSummary.disb.t += d.target; kpiSummary.disb.a += d.actual; }
                else if(d.kpiType.includes('Apprisal')) { kpiSummary.appr.t += d.target; kpiSummary.appr.a += d.actual; }
                else if(d.kpiType.includes('OD Recovery')) { kpiSummary.od.t += d.target; kpiSummary.od.a += d.actual; }
                else if(d.kpiType.includes('Regular Collection')) { kpiSummary.reg.t += d.target; kpiSummary.reg.a += d.actual; }
                else if(d.kpiType.includes('Past Due')) { kpiSummary.past.t += d.target; kpiSummary.past.a += d.actual; }
                else if(d.kpiType.includes('Rocket Pay')) { kpiSummary.rocket.t += d.target; kpiSummary.rocket.a += d.actual; }
                else if(d.kpiType.includes('Meeting')) { kpiSummary.meet.t += d.target; kpiSummary.meet.a += d.actual; }
            });

            updateUI(kpiSummary, filtered);
        }

        // 5. UI Components
        function updateUI(summary, rawFiltered) {
            // Update Score Cards
            setVal('valDisb', 'percDisb', summary.disb, true);
            setVal('valAppr', 'percAppr', summary.appr, true);
            setVal('valOD', 'percOD', summary.od, true);
            setVal('valReg', 'percReg', summary.reg, true);
            setVal('valPast', 'percPast', summary.past, true);
            setVal('valRocket', 'percRocket', summary.rocket, true);
            setVal('valMeet', 'percMeet', summary.meet, false);

            // Update Chart
            renderChart(summary);

            // Update Table & Ranks
            renderTable(rawFiltered);
            renderRanks(rawFiltered);
        }

        function setVal(vId, pId, obj, isCurrency) {
            const perc = obj.t > 0 ? ((obj.a / obj.t) * 100).toFixed(1) : 0;
            document.getElementById(vId).innerText = isCurrency ? `₹ ${formatINR(obj.a)}` : obj.a;
            document.getElementById(pId).innerText = `${perc}% Achieved`;
        }

        function renderChart(summary) {
            const ctx = document.getElementById('perfChart').getContext('2d');
            const data = {
                labels: ['Disb', 'Appr', 'OD', 'Reg', 'Past', 'Rocket', 'Meet'],
                datasets: [
                    { label: 'Achievement', data: [summary.disb.a, summary.appr.a, summary.od.a, summary.reg.a, summary.past.a, summary.rocket.a, summary.meet.a], backgroundColor: '#2563eb', borderRadius: 8 },
                    { label: 'Target', data: [summary.disb.t, summary.appr.t, summary.od.t, summary.reg.t, summary.past.t, summary.rocket.t, summary.meet.t], backgroundColor: '#e2e8f0', borderRadius: 8 }
                ]
            };

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        function renderRanks(data) {
            const list = document.getElementById('rankList');
            list.innerHTML = "";

            // Group by staff
            const staffTotals = {};
            data.forEach(d => {
                if(!staffTotals[d.staff]) staffTotals[d.staff] = { name: d.staff, mgr: d.mgr, a: 0, t: 0 };
                staffTotals[d.staff].a += d.actual;
                staffTotals[d.staff].t += d.target;
            });

            const sorted = Object.values(staffTotals).sort((a,b) => (b.a/b.t) - (a.a/a.t));
            
            sorted.slice(0, 10).forEach((s, i) => {
                const eff = s.t > 0 ? ((s.a/s.t)*100).toFixed(0) : 0;
                list.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <span class="w-7 h-7 bg-white text-[10px] font-black flex items-center justify-center rounded-full border border-slate-200">${i+1}</span>
                            <div>
                                <p class="text-sm font-black text-slate-800">${s.name}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">${s.mgr}</p>
                            </div>
                        </div>
                        <span class="font-black text-blue-600 text-sm">${eff}%</span>
                    </div>
                `;
            });
        }

        function renderTable(data) {
            const body = document.getElementById('auditTable');
            body.innerHTML = "";
            
            // Group data by staff and date for row aggregation
            const grouped = {};
            data.forEach(d => {
                const key = `${d.staff}-${d.sDate}`;
                if(!grouped[key]) {
                    grouped[key] = { staff: d.staff, mgr: d.mgr, date: d.sDate, dAch:0, dTar:0, rAch:0, rTar:0, rocket:0 };
                }
                if(d.kpiType.includes('Disbursement')) { grouped[key].dAch += d.actual; grouped[key].dTar += d.target; }
                if(d.kpiType.includes('Regular')) { grouped[key].rAch += d.actual; grouped[key].rTar += d.target; }
                if(d.kpiType.includes('Rocket')) { grouped[key].rocket += d.actual; }
            });

            const rows = Object.values(grouped);
            document.getElementById('rowCounter').innerText = `${rows.length} Records Found`;

            rows.forEach(r => {
                const dEff = r.dTar > 0 ? ((r.dAch/r.dTar)*100).toFixed(0) : 0;
                const rEff = r.rTar > 0 ? ((r.rAch/r.rTar)*100).toFixed(0) : 0;
                const overall = ((parseInt(dEff) + parseInt(rEff)) / 2).toFixed(0);

                let badge = "bg-warning-soft";
                let status = "Average";
                if(overall > 85) { badge="bg-success-soft"; status="Elite"; }
                if(overall < 50) { badge="bg-danger-soft"; status="Critical"; }

                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-all">
                        <td class="px-8 py-5">
                            <p class="font-black text-slate-700">${r.staff}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${r.mgr} | ${r.date}</p>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-2">
                                <span class="text-[11px] font-black w-8">${dEff}%</span>
                                <div class="w-16 h-1 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-600" style="width: ${dEff}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-2">
                                <span class="text-[11px] font-black w-8">${rEff}%</span>
                                <div class="w-16 h-1 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-500" style="width: ${rEff}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 font-bold text-xs text-slate-600">₹ ${formatINR(r.rocket)}</td>
                        <td class="px-6 py-5 text-center">
                            <span class="efficiency-badge ${badge}">${status}</span>
                        </td>
                    </tr>
                `;
            });
        }

        function formatINR(num) {
            return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(num);
        }

        window.onload = init;
    </script>
</body>
</html>
