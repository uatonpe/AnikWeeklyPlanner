<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Fin Strategic Portal</title>
    <!-- CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f6ff; color: #1e293b; }
        .pro-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .sidebar-accent { border-left: 5px solid #0056b3; }
        .nav-gradient { background: #ffffff; border-bottom: 2px solid #eef2f6; }
        
        /* Loading Spinner */
        .loader-wrapper { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 45px; height: 45px; border: 4px solid #f3f3f3; border-top: 4px solid #0056b3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-card-view { display: block; }
        }
        @media (min-width: 769px) {
            .desktop-table { display: table; }
            .mobile-card-view { display: none; }
        }

        .input-pro { width: 100%; padding: 10px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; transition: 0.2s; }
        .input-pro:focus { border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
        .btn-primary { background: #0056b3; color: white; padding: 12px 24px; border-radius: 12px; font-weight: 700; transition: 0.3s; }
        .btn-primary:hover { background: #004494; transform: translateY(-2px); }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" class="loader-wrapper">
        <div class="spinner"></div>
        <p class="mt-4 font-bold text-blue-900 tracking-wide">‡§°‡•á‡§ü‡§æ ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</p>
    </div>

    <!-- Navigation Bar -->
    <nav class="nav-gradient sticky top-0 z-50 p-4 shadow-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" alt="Anik Fin Logo" class="h-10 md:h-12 object-contain">
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <span class="text-xs font-bold text-gray-400 uppercase hidden md:block">Manager:</span>
                <select id="mgrSelector" onchange="initPortal()" class="w-full md:w-64 p-3 rounded-xl border-2 border-blue-50 bg-blue-50/50 font-bold text-blue-900 outline-none focus:border-blue-500">
                    <option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>
                </select>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Dashboard Placeholder -->
        <div id="welcomeScreen" class="text-center py-20 flex flex-col items-center">
            <div class="bg-blue-100 p-6 rounded-full mb-6 animate-bounce">üìä</div>
            <h2 class="text-2xl font-black text-blue-900">Anik Fin Strategic Planning Portal</h2>
            <p class="text-gray-500 mt-2">‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ì‡§≥‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-8 animate-in fade-in">
            
            <!-- KPI Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                <div class="pro-card p-5 sidebar-accent">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">‡§µ‡§æ‡§ü‡§™ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü</p>
                    <h3 id="statDisb" class="text-xl md:text-2xl font-black text-blue-900 mt-1">‚Çπ 0</h3>
                </div>
                <div class="pro-card p-5 sidebar-accent border-emerald-500" style="border-left-color: #10b981;">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä ‡§Ö‡§ö‡•Ä‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü</p>
                    <h3 id="statAch" class="text-xl md:text-2xl font-black text-emerald-600 mt-1">0%</h3>
                </div>
                <div class="pro-card p-5 sidebar-accent border-orange-400" style="border-left-color: #fb923c;">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">‡§è‡§ï‡•Ç‡§£ OD ‡§ñ‡§æ‡§§‡•á</p>
                    <h3 id="statOd" class="text-xl md:text-2xl font-black text-orange-600 mt-1">0</h3>
                </div>
                <div class="pro-card p-5 sidebar-accent border-purple-500" style="border-left-color: #a855f7;">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">FX ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</p>
                    <h3 id="statUnits" class="text-xl md:text-2xl font-black text-purple-600 mt-1">0</h3>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="pro-card p-6 h-[300px]">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-widest">‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§Ö‡§ö‡•Ä‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</h4>
                    <canvas id="achChart"></canvas>
                </div>
                <div class="pro-card p-6 h-[300px]">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-widest">OD ‡§ï‡§µ‡•ç‡§π‡§∞‡•á‡§ú ‡§ü‡•ç‡§∞‡•á‡§Ç‡§°</h4>
                    <canvas id="odChart"></canvas>
                </div>
            </div>

            <!-- Planning Form -->
            <form id="planningForm" class="pro-card overflow-hidden">
                <div class="bg-blue-50/50 p-6 md:p-8 border-b border-blue-100">
                    <h3 class="text-lg font-bold text-blue-900 mb-4">‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§™‡•ç‡§≤‡•Ö‡§® ‡§§‡§™‡§∂‡•Ä‡§≤</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase mb-2 block">‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§™‡§æ‡§∏‡•Ç‡§®</label>
                            <input type="date" id="planStart" required class="input-pro font-bold text-blue-900">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase mb-2 block">‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§</label>
                            <input type="date" id="planEnd" required class="input-pro font-bold text-blue-900">
                        </div>
                    </div>
                </div>

                <div class="p-4 md:p-0">
                    <!-- Desktop View -->
                    <table class="w-full desktop-table">
                        <thead class="bg-gray-50 text-[11px] text-gray-400 uppercase">
                            <tr>
                                <th class="p-4 text-left">FX ‡§Ø‡•Å‡§®‡§ø‡§ü</th>
                                <th class="p-4">‡§µ‡§æ‡§ü‡§™ ‡§∞‡§ï‡•ç‡§ï‡§Æ</th>
                                <th class="p-4">‡§Ö‡•Ö‡§ü‡•ã ‡§™‡•á</th>
                                <th class="p-4">OD (Qty | Amt)</th>
                                <th class="p-4">‡•≤‡§ï‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡•Ö‡§®</th>
                                <th class="p-4">Ach %</th>
                            </tr>
                        </thead>
                        <tbody id="fxDesktopBody"></tbody>
                    </table>

                    <!-- Mobile View -->
                    <div id="fxMobileBody" class="mobile-card-view space-y-4 p-2"></div>

                    <div class="p-8 flex justify-center bg-gray-50/50">
                        <button type="submit" class="btn-primary w-full md:w-auto shadow-xl">‡§™‡•ç‡§≤‡•Ö‡§® ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <footer class="p-10 text-center text-gray-400 text-xs">
        &copy; 2025 Anik Financial Services | Pro Management Suite
    </footer>

    <script>
        // API URL
        const APP_URL = "https://script.google.com/macros/s/AKfycbwHg4SmoLrehfinJj3uwMbXiyxIZZ_ZaBT09dmxwUxoFzBg3ULbEz_0xJez3HvxV37f/exec";
        let c1, c2;

        // ‡•ß. ‡§≤‡•ã‡§° ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞
        window.onload = async () => {
            toggleLoader(true);
            try {
                const res = await fetch(`${APP_URL}?action=getManagers`);
                const managers = await res.json();
                const sel = document.getElementById('mgrSelector');
                sel.innerHTML = '<option value="">-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
                managers.forEach(m => sel.add(new Option(m, m)));
            } catch (e) { alert("‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä!"); }
            toggleLoader(false);
        };

        // ‡•®. ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§á‡§ú ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°
        async function initPortal() {
            const manager = document.getElementById('mgrSelector').value;
            if (!manager) {
                document.getElementById('welcomeScreen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                return;
            }

            toggleLoader(true);
            const res = await fetch(`${APP_URL}?action=getDetails&manager=${encodeURIComponent(manager)}`);
            const { fxList, prevData } = await res.json();

            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('statUnits').innerText = fxList.length;

            renderInputs(fxList);
            if(prevData) renderCharts(prevData.fxDetails);
            toggleLoader(false);
        }

        // ‡•©. ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ (‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ + ‡§°‡•á‡§∏‡•ç‡§ï‡§ü‡•â‡§™ ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä‡§∏‡§æ‡§†‡•Ä)
        function renderInputs(list) {
            const dBody = document.getElementById('fxDesktopBody');
            const mBody = document.getElementById('fxMobileBody');
            dBody.innerHTML = ""; mBody.innerHTML = "";

            list.forEach(fx => {
                // Desktop Row
                dBody.insertAdjacentHTML('beforeend', `
                    <tr class="border-b">
                        <td class="p-4 font-bold text-blue-900">${fx}<input type="hidden" class="fx-name" value="${fx}"></td>
                        <td class="p-2"><input type="number" class="fx-disb input-pro" oninput="liveCalc()"></td>
                        <td class="p-2"><input type="number" class="fx-auto input-pro"></td>
                        <td class="p-2 flex gap-1"><input type="number" class="fx-odq w-16 input-pro" oninput="liveCalc()"><input type="number" class="fx-oda flex-grow input-pro"></td>
                        <td class="p-2"><input type="text" class="fx-pd input-pro"></td>
                        <td class="p-2"><input type="number" class="fx-ach input-pro bg-blue-50 font-bold"></td>
                    </tr>
                `);

                // Mobile Card
                mBody.insertAdjacentHTML('beforeend', `
                    <div class="pro-card p-5 space-y-3">
                        <div class="font-bold text-blue-900 border-b pb-2 mb-2 flex justify-between">
                            <span>${fx}</span> <span class="text-[10px] text-blue-400 uppercase">Unit</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase">‡§µ‡§æ‡§ü‡§™ ‡§∞‡§ï‡•ç‡§ï‡§Æ</label><input type="number" class="fx-disb-m input-pro" oninput="liveCalc()"></div>
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase">‡§Ö‡•Ö‡§ü‡•ã ‡§™‡•á</label><input type="number" class="fx-auto-m input-pro"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase">OD ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label><input type="number" class="fx-odq-m input-pro" oninput="liveCalc()"></div>
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase">OD ‡§∞‡§ï‡•ç‡§ï‡§Æ</label><input type="number" class="fx-oda-m input-pro"></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">‡•≤‡§ï‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡•Ö‡§®</label><input type="text" class="fx-pd-m input-pro"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">‡§Ö‡§ö‡•Ä‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü %</label><input type="number" class="fx-ach-m input-pro bg-blue-50"></div>
                    </div>
                `);
            });
        }

        // ‡•™. ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏ (Power BI Style)
        function renderCharts(data) {
            const labels = data.map(f => f.name);
            const achs = data.map(f => f.ach || 0);
            const ods = data.map(f => f.odCount || 0);

            const avg = (achs.reduce((a, b) => a + Number(b), 0) / achs.length).toFixed(1);
            document.getElementById('statAch').innerText = avg + "%";

            if(c1) c1.destroy();
            c1 = new Chart(document.getElementById('achChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Achievement %', data: achs, backgroundColor: '#0056b3', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            if(c2) c2.destroy();
            c2 = new Chart(document.getElementById('odChart'), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'OD Target', data: ods, borderColor: '#fb923c', tension: 0.4, fill: true, backgroundColor: 'rgba(251, 146, 60, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // ‡•´. ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§Ü‡§ï‡§°‡•á‡§Æ‡•ã‡§°
        function liveCalc() {
            let totalD = 0, totalO = 0;
            const isMobile = window.innerWidth <= 768;
            
            const disbInputs = isMobile ? document.querySelectorAll('.fx-disb-m') : document.querySelectorAll('.fx-disb');
            const odInputs = isMobile ? document.querySelectorAll('.fx-odq-m') : document.querySelectorAll('.fx-odq');

            disbInputs.forEach(i => totalD += Number(i.value || 0));
            odInputs.forEach(i => totalO += Number(i.value || 0));

            document.getElementById('statDisb').innerText = "‚Çπ " + totalD.toLocaleString('hi-IN');
            document.getElementById('statOd').innerText = totalO;
        }

        // ‡•¨. ‡§∏‡§¨‡§Æ‡§ø‡§ü
        document.getElementById('planningForm').onsubmit = async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const isMobile = window.innerWidth <= 768;
            const fxDetails = [];

            if(isMobile) {
                document.querySelectorAll('#fxMobileBody .pro-card').forEach(card => {
                    fxDetails.push({
                        name: card.querySelector('.font-bold span').innerText,
                        disb: card.querySelector('.fx-disb-m').value,
                        auto: card.querySelector('.fx-auto-m').value,
                        odCount: card.querySelector('.fx-odq-m').value,
                        odAmt: card.querySelector('.fx-oda-m').value,
                        pd: card.querySelector('.fx-pd-m').value,
                        ach: card.querySelector('.fx-ach-m').value
                    });
                });
            } else {
                document.querySelectorAll('#fxDesktopBody tr').forEach(row => {
                    fxDetails.push({
                        name: row.querySelector('.fx-name').value,
                        disb: row.querySelector('.fx-disb').value,
                        auto: row.querySelector('.fx-auto').value,
                        odCount: row.querySelector('.fx-odq').value,
                        odAmt: row.querySelector('.fx-oda').value,
                        pd: row.querySelector('.fx-pd').value,
                        ach: row.querySelector('.fx-ach').value
                    });
                });
            }

            const payload = {
                manager: document.getElementById('mgrSelector').value,
                sDate: document.getElementById('planStart').value,
                eDate: document.getElementById('planEnd').value,
                fxDetails: fxDetails
            };

            try {
                const res = await fetch(APP_URL, { method: "POST", body: JSON.stringify(payload) });
                const result = await res.json();
                if(result.status === "SUCCESS") {
                    alert("‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§™‡•ç‡§≤‡•Ö‡§® ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡§æ!");
                    location.reload();
                }
            } catch (e) { alert("Error: ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡•á ‡§®‡§æ‡§π‡•Ä."); }
            toggleLoader(false);
        };

        function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>
