<!DOCTYPE html>
<html>
<head>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f0f4f8; font-family: 'Inter', sans-serif; }
    .glass-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .fx-row { border-bottom: 1px solid #edf2f7; padding: 15px 0; }
    .label-custom { font-size: 11px; font-weight: 700; color: #4a5568; text-transform: uppercase; }
    input { border: 1px solid #cbd5e0; border-radius: 5px; padding: 5px 8px; font-size: 14px; width: 100%; }
    input:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
  </style>
</head>
<body class="p-4">

<div class="max-w-6xl mx-auto">
  <!-- Top Bar -->
  <div class="glass-card p-6 mb-6 flex flex-col md:flex-row justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
    <div>
      <h1 class="text-2xl font-bold">Weekly Performance Planner</h1>
      <p class="opacity-80">मॅनेजर डॅशबोर्ड</p>
    </div>
    <div class="mt-4 md:mt-0 w-full md:w-64">
      <label class="text-white text-xs font-bold">मॅनेजर निवडा</label>
      <select id="mgrSelect" onchange="loadManagerData()" class="w-full p-2 rounded text-gray-900 font-semibold">
        <option value="">-- निवडा --</option>
      </select>
    </div>
  </div>

  <!-- Dashboard Stats (Power BI View) -->
  <div id="statsSection" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 hidden">
    <div class="glass-card p-4 border-t-4 border-blue-500">
      <p class="label-custom">मागील अचीव्हमेंट ट्रेंड</p>
      <canvas id="achChart" height="150"></canvas>
    </div>
    <div class="glass-card p-4 border-t-4 border-green-500 flex flex-col justify-center items-center">
      <p class="label-custom">एकूण FX संख्या</p>
      <h2 id="fxCountHeader" class="text-5xl font-black text-indigo-600">0</h2>
    </div>
    <div class="glass-card p-4 border-t-4 border-purple-500">
      <p class="label-custom">मागील ओडी कव्हरेज</p>
      <canvas id="odChart" height="150"></canvas>
    </div>
  </div>

  <!-- Planning Form -->
  <form id="planForm" class="hidden">
    <div class="glass-card p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div><label class="label-custom">दिनांक पासून</label><input type="date" id="sDate" required></div>
        <div><label class="label-custom">दिनांक पर्यंत</label><input type="date" id="eDate" required></div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="p-3 label-custom">FX नाव</th>
              <th class="p-3 label-custom">वाटप रक्कम</th>
              <th class="p-3 label-custom">अॅटो पे</th>
              <th class="p-3 label-custom">OD (संख्या/रक्कम)</th>
              <th class="p-3 label-custom">Past Due ॲक्शन</th>
              <th class="p-3 label-custom text-red-500">मागील अचीव्हमेंट %</th>
            </tr>
          </thead>
          <tbody id="fxTableBody">
            <!-- FX Rows will be injected here -->
          </tbody>
        </table>
      </div>

      <div class="mt-8 text-right">
        <button type="submit" class="bg-indigo-600 text-white px-10 py-3 rounded-full font-bold shadow-xl hover:bg-indigo-700 transition transform hover:scale-105">
          वीकली प्लॅन सबमिट करा
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // १. लोड मॅनेजर लिस्ट
  window.onload = function() {
    google.script.run.withSuccessHandler(list => {
      let sel = document.getElementById('mgrSelect');
      list.forEach(m => { let opt = new Option(m, m); sel.add(opt); });
    }).getManagers();
  };

  // २. मॅनेजर निवडल्यावर त्याचे FX आणि चार्ट्स लोड करणे
  function loadManagerData() {
    let mgr = document.getElementById('mgrSelect').value;
    if(!mgr) return;

    // FX लिस्ट मिळवणे
    google.script.run.withSuccessHandler(fxList => {
      const tbody = document.getElementById('fxTableBody');
      tbody.innerHTML = "";
      document.getElementById('fxCountHeader').innerText = fxList.length;
      
      fxList.forEach(fx => {
        let row = `
          <tr class="fx-row">
            <td class="p-3 font-bold text-indigo-700">${fx}<input type="hidden" class="fx-name" value="${fx}"></td>
            <td class="p-3"><input type="number" class="fx-disb" placeholder="₹"></td>
            <td class="p-3"><input type="number" class="fx-auto" placeholder="₹"></td>
            <td class="p-3"><input type="text" class="fx-od" placeholder="उदा. 5 / 20000"></td>
            <td class="p-3"><input type="text" class="fx-pd" placeholder="ॲक्शन काय?"></td>
            <td class="p-3"><input type="number" class="fx-prev" placeholder="0-100"></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
      document.getElementById('planForm').classList.remove('hidden');
      document.getElementById('statsSection').classList.remove('hidden');
    }).getFXListForManager(mgr);

    // मागील चार्ट डेटा लोड करणे
    google.script.run.withSuccessHandler(data => {
      if(data) renderCharts(data.fxData);
    }).getLastPlan(mgr);
  }

  function renderCharts(fxData) {
    const labels = fxData.map(d => d.name);
    const achs = fxData.map(d => d.ach);
    
    new Chart(document.getElementById('achChart'), {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: 'Achievement %', data: achs, backgroundColor: '#6366f1' }] },
      options: { plugins: { legend: { display: false } } }
    });
  }

  // ३. सबमिट करणे
  document.getElementById('planForm').onsubmit = function(e) {
    e.preventDefault();
    let payload = {
      manager: document.getElementById('mgrSelect').value,
      sDate: document.getElementById('sDate').value,
      eDate: document.getElementById('eDate').value,
      fxDetails: []
    };

    document.querySelectorAll('#fxTableBody tr').forEach(row => {
      payload.fxDetails.push({
        name: row.querySelector('.fx-name').value,
        disb: row.querySelector('.fx-disb').value,
        auto: row.querySelector('.fx-auto').value,
        od: row.querySelector('.fx-od').value,
        pd: row.querySelector('.fx-pd').value,
        ach: row.querySelector('.fx-prev').value
      });
    });

    google.script.run.withSuccessHandler(msg => {
      alert(msg);
      location.reload();
    }).saveData(payload);
  };
</script>
</body>
</html>
