<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>Anik Manager Planner | LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --anik-blue: #1e40af; --anik-bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--anik-bg); color: #0f172a; }
        .system-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: 0.3s; }
        .system-input { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid #e2e8f0; font-weight: 600; outline: none; transition: 0.3s; }
        .system-input:focus { border-color: var(--anik-blue); box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1); }
        .staff-section { border-left: 8px solid var(--anik-blue); margin-bottom: 40px; }
    </style>
</head>
<body class="p-6 md:p-12">
    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-12 border-b pb-8">
        <div class="flex items-center gap-4">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-10">
            <h1 class="text-2xl font-black uppercase text-slate-800 tracking-tighter">Strategic Planner (LIVE)</h1>
        </div>
        <div class="flex flex-wrap gap-4 mt-6 md:mt-0">
            <select id="mgrSelect" class="system-input bg-blue-50 w-64" onchange="loadManagerStaff()">
                <option value="">-- मॅनेजर निवडा --</option>
            </select>
            <input type="date" id="sDate" class="system-input w-44">
            <input type="date" id="eDate" class="system-input w-44">
        </div>
    </nav>

    <main id="plannerBox" class="max-w-7xl mx-auto space-y-8">
        <!-- Live Staff Cards will appear here -->
        <div class="p-20 text-center text-slate-400 font-bold border-4 border-dashed rounded-[40px]">
            काम सुरू करण्यासाठी मॅनेजर आणि तारीख निवडा...
        </div>
    </main>

    <footer class="max-w-7xl mx-auto mt-12 flex justify-end">
        <button onclick="submitPlan()" id="submitBtn" class="hidden bg-blue-700 text-white px-12 py-5 rounded-2xl font-black uppercase tracking-widest hover:scale-105 transition-all shadow-xl">
            साप्ताहिक टार्गेट लॉक करा
        </button>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrsdH0yjhKLl6mQi7pnq6l__J3M3BZvmqseBxYDamv18zi6o8BfRcPcYIK06Boy6Ma/exec"; 
        const KPI_QUESTIONS = [
            "New Loan Disbursement (Target ₹)",
            "New Loan Apprisal (Target ₹)",
            "OD Recovery (Target ₹)",
            "Regular Collection (Target ₹)",
            "Past Due (Target ₹)",
            "Auto Pay Rocket Pay",
            "New Group Meeting"
        ];

        let currentStaffList = [];

        // १. लोड मॅनेजर्स
        async function init() {
            const resp = await fetch(`${SCRIPT_URL}?action=getManagers`);
            const managers = await resp.json();
            const sel = document.getElementById('mgrSelect');
            managers.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
        }

        // २. मॅनेजरचे स्टाफ लोड करा
        async function loadManagerStaff() {
            const mgr = document.getElementById('mgrSelect').value;
            if(!mgr) return;

            document.getElementById('plannerBox').innerHTML = "<p class='text-center p-10 font-bold'>स्टाफ लिस्ट लोड होत आहे...</p>";
            
            const resp = await fetch(`${SCRIPT_URL}?action=getManagerData&manager=${encodeURIComponent(mgr)}`);
            const data = await resp.json();
            currentStaffList = data.fxList;

            renderUI();
        }

        function renderUI() {
            const container = document.getElementById('plannerBox');
            container.innerHTML = "";
            document.getElementById('submitBtn').classList.remove('hidden');

            currentStaffList.forEach(staff => {
                const section = document.createElement('div');
                section.className = "system-card p-8 staff-section";
                
                let rows = KPI_QUESTIONS.map(q => `
                    <tr class="border-b border-slate-50">
                        <td class="py-4 font-bold text-slate-700 text-sm">${q}</td>
                        <td class="py-4 px-4"><input type="number" data-staff="${staff}" data-q="${q}" class="target-val system-input" placeholder="0"></td>
                        <td class="py-4"><input type="text" data-staff="${staff}" data-q="${q}" class="target-note system-input" placeholder="नोंद..."></td>
                    </tr>
                `).join('');

                section.innerHTML = `
                    <h3 class="text-xl font-black text-blue-800 mb-6 flex items-center gap-3">
                        <span class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">${staff.charAt(0)}</span> ${staff}
                    </h3>
                    <table class="w-full">
                        <thead><tr class="text-[10px] font-black text-slate-400 uppercase"><th>KPI Question</th><th class="px-4">Target Amount</th><th>Strategy</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
                container.appendChild(section);
            });
        }

        // ३. डेटा शीटमध्ये पाठवा (doPost)
        async function submitPlan() {
            const mgr = document.getElementById('mgrSelect').value;
            const sDate = document.getElementById('sDate').value;
            const eDate = document.getElementById('eDate').value;

            if(!sDate || !eDate) return alert("तारीख भरा!");

            const fxDetails = [];
            document.querySelectorAll('.target-val').forEach((el, i) => {
                const note = document.querySelectorAll('.target-note')[i].value;
                fxDetails.push({
                    name: el.dataset.staff + " || " + el.dataset.q,
                    tDisb: el.value || 0,
                    aDisb: 0, // Initial actual is 0
                    pd: note
                });
            });

            const payload = { manager: mgr, sDate: sDate, eDate: eDate, fxDetails: fxDetails };

            const resp = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await resp.json();
            alert(result.message);
            location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>
