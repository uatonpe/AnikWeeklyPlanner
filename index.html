<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anik Fin Pro Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f4f7ff; }
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f0f4f8; overflow: hidden; }
        .input-pro { width: 100%; padding: 12px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 14px; outline: none; transition: 0.2s; }
        .input-pro:focus { border-color: #3b82f6; background: #fff; }
        .btn-main { background: #1e40af; color: white; padding: 16px; border-radius: 16px; font-weight: 800; width: 100%; transition: 0.3s; box-shadow: 0 10px 15px -3px rgba(30, 64, 175, 0.3); }
        .btn-main:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Mobile List Optimization */
        @media (max-width: 640px) {
            .table-container { display: none; }
            .mobile-list { display: block; }
        }
        @media (min-width: 641px) {
            .table-container { display: block; }
            .mobile-list { display: none; }
        }
    </style>
</head>
<body class="pb-10">

    <div id="loader" class="loader-overlay">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-blue-900">Securely Connecting...</p>
    </div>

    <nav class="glass-header p-4">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-8 md:h-10">
            <select id="manager" onchange="loadData()" class="bg-blue-50 border-none rounded-xl p-2 text-sm font-bold text-blue-900 outline-none">
                <option value="">निवडा...</option>
            </select>
        </div>
    </nav>

    <main id="mainContent" class="max-w-5xl mx-auto p-4 space-y-6 hidden">
        
        <!-- Blocker Message for Last Week Achievement -->
        <div id="blocker" class="hidden card bg-red-50 border-red-200 p-6 flex items-center gap-4 animate-pulse">
            <span class="text-3xl">⚠️</span>
            <div>
                <h4 class="font-extrabold text-red-800 uppercase text-xs tracking-widest">Achievement Pending</h4>
                <p class="text-red-600 text-sm">तुम्ही मागील आठवड्याचे Achievement भरलेले नाही. कृपया आधी मागील प्लॅन अपडेट करा.</p>
            </div>
        </div>

        <!-- Dynamic KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card p-4 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Target</p>
                <p id="kpiT" class="text-lg font-black text-slate-900">₹ 0</p>
            </div>
            <div class="card p-4 text-center border-emerald-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Actual</p>
                <p id="kpiA" class="text-lg font-black text-emerald-600">₹ 0</p>
            </div>
            <div class="card p-4 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Eff. %</p>
                <p id="kpiE" class="text-lg font-black text-orange-500">0%</p>
            </div>
            <div class="card p-4 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Units</p>
                <p id="kpiU" class="text-lg font-black text-blue-700">0</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex gap-2 p-1 bg-white rounded-2xl border w-full md:w-fit">
            <button onclick="tab(1)" id="t1" class="flex-1 px-6 py-2 rounded-xl font-bold text-xs transition bg-blue-600 text-white">Create Plan</button>
            <button onclick="tab(2)" id="t2" class="flex-1 px-6 py-2 rounded-xl font-bold text-xs transition text-slate-500">History</button>
        </div>

        <!-- FORM SECTION -->
        <div id="sec1">
            <form id="pForm" class="space-y-6">
                <div class="card p-6 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white">
                    <div><label class="text-[10px] font-bold uppercase text-slate-400">Start Date</label><input type="date" id="sDate" required class="input-pro font-bold"></div>
                    <div><label class="text-[10px] font-bold uppercase text-slate-400">End Date</label><input type="date" id="eDate" required class="input-pro font-bold"></div>
                </div>

                <div class="table-container card">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-[10px] font-bold uppercase text-slate-500">
                            <tr>
                                <th class="p-4 text-left">FX Unit</th>
                                <th class="p-4">Target (₹)</th>
                                <th class="p-4">Actual (₹)</th>
                                <th class="p-4">OD (P|A)</th>
                                <th class="p-4">Action Plan</th>
                            </tr>
                        </thead>
                        <tbody id="pcRows"></tbody>
                    </table>
                </div>

                <!-- Pro Mobile Card List -->
                <div id="mobRows" class="mobile-list space-y-4"></div>

                <button type="submit" id="submitBtn" class="btn-main">सबमिट प्लॅन</button>
            </form>
        </div>

        <!-- HISTORY SECTION -->
        <div id="sec2" class="hidden space-y-4">
            <div id="historyList" class="space-y-4"></div>
        </div>

    </main>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxrsdH0yjhKLl6mQi7pnq6l__J3M3BZvmqseBxYDamv18zi6o8BfRcPcYIK06Boy6Ma/exec";
        let state = { fx: [], history: [], pendingAch: false };

        window.onload = () => {
            toggleLoader(true);
            fetch(`${API}?action=getManagers`).then(r => r.json()).then(d => {
                const s = document.getElementById('manager');
                d.forEach(m => s.add(new Option(m,m)));
                toggleLoader(false);
            });
        };

        async function loadData() {
            const m = document.getElementById('manager').value;
            if(!m) return;
            toggleLoader(true);
            const r = await fetch(`${API}?action=getManagerData&manager=${encodeURIComponent(m)}`);
            const d = await r.json();
            state.fx = d.fxList;
            state.history = d.history;
            
            checkPending();
            renderTable();
            document.getElementById('mainContent').classList.remove('hidden');
            toggleLoader(false);
        }

        function checkPending() {
            if(state.history.length > 0) {
                const last = state.history[state.history.length - 1];
                let incomplete = false;
                last.details.forEach(item => { if(!item.aDisb) incomplete = true; });
                
                state.pendingAch = incomplete;
                const b = document.getElementById('blocker');
                const btn = document.getElementById('submitBtn');
                
                if(incomplete) {
                    b.classList.remove('hidden');
                    document.getElementById('sDate').value = last.sDate;
                    document.getElementById('eDate').value = last.eDate;
                    document.getElementById('sDate').readOnly = true;
                    btn.innerText = "मागील अचीव्हमेंट अपडेट करा";
                } else {
                    b.classList.add('hidden');
                    document.getElementById('sDate').value = "";
                    document.getElementById('sDate').readOnly = false;
                    btn.innerText = "नवीन प्लॅन सबमिट करा";
                }
            }
        }

        function renderTable() {
            const pc = document.getElementById('pcRows');
            const mb = document.getElementById('mobRows');
            pc.innerHTML = ""; mb.innerHTML = "";
            
            const lastData = state.pendingAch ? state.history[state.history.length - 1].details : null;

            state.fx.forEach((name, i) => {
                const prev = lastData ? lastData.find(ld => ld.name === name) : { tDisb: '', aDisb: '', tOd: '', aOd: '', pd: '' };
                
                // Desktop
                pc.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4 font-bold text-blue-900">${name}</td>
                        <td class="p-2"><input type="number" class="val-tDisb input-pro" value="${prev.tDisb}" ${state.pendingAch ? 'readonly' : ''} oninput="liveKPI()"></td>
                        <td class="p-2"><input type="number" class="val-aDisb input-pro bg-emerald-50" value="${prev.aDisb}" oninput="liveKPI()"></td>
                        <td class="p-2 flex gap-1"><input type="number" class="val-tOd w-12 input-pro" value="${prev.tOd}"><input type="number" class="val-aOd w-12 input-pro bg-emerald-50" value="${prev.aOd}"></td>
                        <td class="p-2"><input type="text" class="val-pd input-pro" value="${prev.pd}"></td>
                        <input type="hidden" class="val-name" value="${name}">
                    </tr>`;
                
                // Mobile Card View
                mb.innerHTML += `
                    <div class="card p-5 space-y-4">
                        <div class="flex justify-between items-center border-b pb-2"><span class="font-black text-blue-900">${name}</span><span class="status-badge bg-blue-100 text-blue-600">Unit ${i+1}</span></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[9px] font-black text-slate-400 uppercase">Target ₹</label><input type="number" class="val-tDisb input-pro" value="${prev.tDisb}" ${state.pendingAch ? 'readonly' : ''} oninput="liveKPI()"></div>
                            <div><label class="text-[9px] font-black text-slate-400 uppercase">Actual ₹</label><input type="number" class="val-aDisb input-pro bg-emerald-50" value="${prev.aDisb}" oninput="liveKPI()"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[9px] font-black text-slate-400 uppercase">OD (P|A)</label><div class="flex gap-1"><input type="number" class="val-tOd w-1/2 input-pro" value="${prev.tOd}"><input type="number" class="val-aOd w-1/2 input-pro bg-emerald-50" value="${prev.aOd}"></div></div>
                            <div><label class="text-[9px] font-black text-slate-400 uppercase">Past Due Action</label><input type="text" class="val-pd input-pro" value="${prev.pd}"></div>
                        </div>
                    </div>`;
            });
            liveKPI();
            renderHistory();
        }

        function liveKPI() {
            let t = 0, a = 0;
            const isMob = window.innerWidth <= 640;
            const container = isMob ? document.getElementById('mobRows') : document.getElementById('pcRows');
            
            container.querySelectorAll('.val-tDisb').forEach(i => t += Number(i.value || 0));
            container.querySelectorAll('.val-aDisb').forEach(i => a += Number(i.value || 0));
            
            document.getElementById('kpiT').innerText = "₹ " + t.toLocaleString();
            document.getElementById('kpiA').innerText = "₹ " + a.toLocaleString();
            document.getElementById('kpiE').innerText = t > 0 ? ((a/t)*100).toFixed(1) + "%" : "0%";
            document.getElementById('kpiU').innerText = state.fx.length;
        }

        document.getElementById('pForm').onsubmit = async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const isMob = window.innerWidth <= 640;
            const rows = isMob ? document.querySelectorAll('#mobRows > .card') : document.querySelectorAll('#pcRows tr');
            
            const fxDetails = Array.from(rows).map(row => ({
                name: isMob ? row.querySelector('.font-black').innerText : row.querySelector('.val-name').value,
                tDisb: row.querySelector('.val-tDisb').value,
                aDisb: row.querySelector('.val-aDisb').value,
                tOd: row.querySelector('.val-tOd').value,
                aOd: row.querySelector('.val-aOd').value,
                pd: row.querySelector('.val-pd').value
            }));

            const payload = {
                manager: document.getElementById('manager').value,
                sDate: document.getElementById('sDate').value,
                eDate: document.getElementById('eDate').value,
                fxDetails
            };

            const r = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
            const res = await r.json();
            alert(res.message);
            location.reload();
        };

        function renderHistory() {
            const h = document.getElementById('historyList');
            h.innerHTML = state.history.map(row => {
                let t = 0, a = 0;
                row.details.forEach(d => { t += Number(d.tDisb); a += Number(d.aDisb); });
                const eff = t > 0 ? ((a/t)*100).toFixed(1) : 0;
                return `
                <div class="card p-4 flex justify-between items-center bg-white border-l-4 border-blue-600">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">${row.sDate} to ${row.eDate}</p>
                        <p class="text-xs font-black">Achieved: <span class="text-emerald-600">₹ ${a.toLocaleString()}</span> / Target: ₹ ${t.toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <span class="status-badge ${eff >= 90 ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'}">${eff}% Eff.</span>
                    </div>
                </div>`;
            }).reverse().join('');
        }

        function tab(n) {
            document.getElementById('sec1').classList.toggle('hidden', n !== 1);
            document.getElementById('sec2').classList.toggle('hidden', n !== 2);
            document.getElementById('t1').className = n === 1 ? 'flex-1 px-6 py-2 rounded-xl font-bold text-xs bg-blue-600 text-white' : 'flex-1 px-6 py-2 rounded-xl font-bold text-xs text-slate-500';
            document.getElementById('t2').className = n === 2 ? 'flex-1 px-6 py-2 rounded-xl font-bold text-xs bg-blue-600 text-white' : 'flex-1 px-6 py-2 rounded-xl font-bold text-xs text-slate-500';
        }

        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    </script>
</body>
</html>
