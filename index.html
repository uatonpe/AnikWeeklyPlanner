<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>FX Executive Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .input-focus:focus { ring: 2px; ring-color: #6366f1; border-color: transparent; }
    .gradient-bg { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
    .tab-active { border-bottom: 3px solid #6366f1; color: #6366f1; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: none; }
  </style>
</head>
<body class="text-slate-800">

  <!-- Loader -->
  <div id="loader" class="loading-overlay flex flex-col items-center justify-center">
    <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 font-semibold text-indigo-900">‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§Ü‡§π‡•á...</p>
  </div>

  <!-- Sidebar/Nav -->
  <div class="min-h-screen flex flex-col">
    <!-- Top Header -->
    <header class="gradient-bg text-white p-6 shadow-xl">
      <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-extrabold tracking-tight">FX Strategic Portal v2.0</h1>
          <p class="text-indigo-200 text-sm">Corporate Manager Weekly Performance Tracking</p>
        </div>
        
        <div class="w-full md:w-80 bg-white/10 p-3 rounded-xl border border-white/20">
          <label class="block text-xs font-bold uppercase text-indigo-200 mb-1">‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§®‡§ø‡§µ‡§°‡§æ</label>
          <select id="managerSelect" onchange="initManagerSession()" class="w-full bg-slate-900 text-white rounded-lg p-2 outline-none focus:ring-2 ring-indigo-400 transition-all">
            <option value="">-- ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§®‡§ø‡§µ‡§°‡§æ --</option>
          </select>
        </div>
      </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8">
      
      <!-- Placeholder when no manager selected -->
      <div id="welcomeScreen" class="text-center py-20">
        <div class="text-6xl mb-4">üìä</div>
        <h2 class="text-2xl font-bold text-slate-400">‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞‡§ö‡•á ‡§®‡§æ‡§µ ‡§®‡§ø‡§µ‡§°‡§æ</h2>
      </div>

      <!-- Main Content (Hidden until manager selected) -->
      <div id="mainDashboard" class="hidden animate-fade-in">
        
        <!-- Power BI Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="glass p-6 rounded-2xl card-shadow border-l-8 border-indigo-600">
            <p class="text-slate-500 text-xs font-bold uppercase">‡§è‡§ï‡•Ç‡§£ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§∞‡§ï‡•ç‡§ï‡§Æ</p>
            <h3 id="statTotalDisb" class="text-2xl font-black text-slate-900 mt-2">‚Çπ 0</h3>
          </div>
          <div class="glass p-6 rounded-2xl card-shadow border-l-8 border-emerald-500">
            <p class="text-slate-500 text-xs font-bold uppercase">‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§Ö‡§ö‡•Ä‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü %</p>
            <h3 id="statAvgAch" class="text-2xl font-black text-emerald-600 mt-2">0%</h3>
          </div>
          <div class="glass p-6 rounded-2xl card-shadow border-l-8 border-amber-500">
            <p class="text-slate-500 text-xs font-bold uppercase">OD ‡§ñ‡§æ‡§§‡•á ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</p>
            <h3 id="statOdCount" class="text-2xl font-black text-amber-600 mt-2">0</h3>
          </div>
          <div class="glass p-6 rounded-2xl card-shadow border-l-8 border-rose-500">
            <p class="text-slate-500 text-xs font-bold uppercase">‡§Æ‡•Ö‡§™ ‡§ï‡•á‡§≤‡•á‡§≤‡•á FX</p>
            <h3 id="statFxCount" class="text-2xl font-black text-rose-600 mt-2">0</h3>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="glass p-6 rounded-2xl card-shadow">
            <h4 class="font-bold text-slate-700 mb-4 flex items-center">
              <span class="w-3 h-3 bg-indigo-600 rounded-full mr-2"></span> ‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§Ö‡•Ö‡§®‡•Ö‡§≤‡§ø‡§∏‡§ø‡§∏
            </h4>
            <div class="h-64">
              <canvas id="performanceChart"></canvas>
            </div>
          </div>
          <div class="glass p-6 rounded-2xl card-shadow">
            <h4 class="font-bold text-slate-700 mb-4 flex items-center">
              <span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span> OD ‡§ï‡§µ‡•ç‡§π‡§∞‡•á‡§ú ‡§°‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§¨‡•ç‡§Ø‡•Å‡§∂‡§®
            </h4>
            <div class="h-64">
              <canvas id="odChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Planning Form -->
        <form id="planningForm" class="glass rounded-2xl card-shadow overflow-hidden">
          <div class="bg-slate-50 p-6 border-b border-slate-200">
            <h4 class="text-lg font-bold text-indigo-900">‡§®‡§µ‡•Ä‡§® ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§™‡•ç‡§≤‡•Ö‡§® ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-1">‡§™‡•ç‡§≤‡•Ö‡§® ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§™‡§æ‡§∏‡•Ç‡§®:</label>
                <input type="date" id="startDate" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-1">‡§™‡•ç‡§≤‡•Ö‡§® ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§:</label>
                <input type="date" id="endDate" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 ring-indigo-500">
              </div>
            </div>
          </div>

          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="w-full min-w-[1000px]">
                <thead>
                  <tr class="text-left text-slate-400 text-xs uppercase tracking-wider">
                    <th class="pb-4 px-2">FX ‡§®‡§æ‡§µ</th>
                    <th class="pb-4 px-2">‡§µ‡§æ‡§ü‡§™ ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th>
                    <th class="pb-4 px-2">‡§Ö‡•Ö‡§ü‡•ã ‡§™‡•á (‚Çπ)</th>
                    <th class="pb-4 px-2">OD (‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ | ‡§∞‡§ï‡•ç‡§ï‡§Æ)</th>
                    <th class="pb-4 px-2">Past Due ‡•≤‡§ï‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡•Ö‡§®</th>
                    <th class="pb-4 px-2 text-indigo-600">‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§Ö‡§ö‡•Ä‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü %</th>
                  </tr>
                </thead>
                <tbody id="fxTableBody">
                  <!-- Dynamic Rows Load Here -->
                </tbody>
              </table>
            </div>

            <div class="mt-8 flex justify-end">
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-12 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-1">
                ‡§™‡•ç‡§≤‡•Ö‡§® ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>

    <footer class="p-6 text-center text-slate-400 text-sm">
      &copy; 2024 Corporate FX Management System | Built with Super Power Functions
    </footer>
  </div>

  <script>
    // Global State
    let currentManager = "";
    let myCharts = {};

    // ‡•ß. ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§≤‡§æ ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≠‡§∞‡§£‡•á
    window.onload = function() {
      showLoader(true);
      google.script.run.withSuccessHandler(managers => {
        const select = document.getElementById('managerSelect');
        managers.forEach(m => {
          let opt = new Option(m, m);
          select.add(opt);
        });
        showLoader(false);
      }).getManagers();
    };

    // ‡•®. ‡§Æ‡•Ö‡§®‡•á‡§ú‡§∞ ‡§®‡§ø‡§µ‡§°‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•á
    function initManagerSession() {
      currentManager = document.getElementById('managerSelect').value;
      if (!currentManager) {
        document.getElementById('welcomeScreen').classList.remove('hidden');
        document.getElementById('mainDashboard').classList.add('hidden');
        return;
      }

      showLoader(true);
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('mainDashboard').classList.remove('hidden');

      // FX ‡§Æ‡•Ö‡§™‡§ø‡§Ç‡§ó ‡§Æ‡§ø‡§≥‡§µ‡§£‡•á
      google.script.run.withSuccessHandler(fxList => {
        buildPlanningTable(fxList);
        document.getElementById('statFxCount').innerText = fxList.length;
        
        // ‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§Ü‡§†‡§µ‡§°‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≥‡§µ‡§£‡•á
        google.script.run.withSuccessHandler(prevData => {
          updateDashboardUI(prevData);
          showLoader(false);
        }).getPreviousData(currentManager);

      }).getFXMapping(currentManager);
    }

    // ‡•©. ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó ‡§ü‡•á‡§¨‡§≤ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•á
    function buildPlanningTable(fxList) {
      const tbody = document.getElementById('fxTableBody');
      tbody.innerHTML = "";

      fxList.forEach((fx, index) => {
        const row = `
          <tr class="border-b border-slate-100 group hover:bg-indigo-50/30 transition-colors">
            <td class="py-4 px-2">
              <span class="font-bold text-indigo-900">${fx}</span>
              <input type="hidden" class="fx-name" value="${fx}">
            </td>
            <td class="py-4 px-2"><input type="number" class="fx-disb w-full p-2 border rounded-lg" placeholder="0.00" oninput="calcStats()"></td>
            <td class="py-4 px-2"><input type="number" class="fx-auto w-full p-2 border rounded-lg" placeholder="0.00"></td>
            <td class="py-4 px-2 flex gap-1">
              <input type="number" class="fx-od-count w-1/3 p-2 border rounded-lg" placeholder="Qty" oninput="calcStats()">
              <input type="number" class="fx-od-amt w-2/3 p-2 border rounded-lg" placeholder="Amt">
            </td>
            <td class="py-4 px-2"><input type="text" class="fx-pd-action w-full p-2 border rounded-lg" placeholder="‡§ï‡§æ‡§Ø ‡•≤‡§ï‡•ç‡§∂‡§® ‡§ò‡•á‡§£‡§æ‡§∞?"></td>
            <td class="py-4 px-2"><input type="number" class="fx-ach w-full p-2 border rounded-lg bg-indigo-50 font-bold text-indigo-700" placeholder="0-100"></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    // ‡•™. ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°‡§µ‡§∞ ‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§£‡•á
    function updateDashboardUI(data) {
      if (!data) return;

      const fxDetails = data.fxDetails;
      const labels = fxDetails.map(f => f.name);
      const achValues = fxDetails.map(f => f.ach || 0);
      const odValues = fxDetails.map(f => f.odCount || 0);

      // ‡§Ü‡§ï‡§°‡•á‡§µ‡§æ‡§∞‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü
      const avgAch = (achValues.reduce((a, b) => a + Number(b), 0) / achValues.length).toFixed(1);
      document.getElementById('statAvgAch').innerText = avgAch + "%";

      // ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§£‡•á
      renderPerformanceChart(labels, achValues);
      renderOdChart(labels, odValues);
    }

    function renderPerformanceChart(labels, values) {
      if (myCharts.perf) myCharts.perf.destroy();
      const ctx = document.getElementById('performanceChart').getContext('2d');
      myCharts.perf = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Achievement %',
            data: values,
            backgroundColor: '#6366f1',
            borderRadius: 8
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderOdChart(labels, values) {
      if (myCharts.od) myCharts.od.destroy();
      const ctx = document.getElementById('odChart').getContext('2d');
      myCharts.od = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'OD Accounts',
            data: values,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // ‡•´. ‡§∞‡§ø‡§Ö‡§≤‡§ü‡§æ‡§á‡§Æ ‡§Ü‡§ï‡§°‡•á‡§Æ‡•ã‡§° (Form Calculation)
    function calcStats() {
      let totalDisb = 0;
      let totalOd = 0;
      document.querySelectorAll('.fx-disb').forEach(input => totalDisb += Number(input.value || 0));
      document.querySelectorAll('.fx-od-count').forEach(input => totalOd += Number(input.value || 0));

      document.getElementById('statTotalDisb').innerText = "‚Çπ " + totalDisb.toLocaleString('hi-IN');
      document.getElementById('statOdCount').innerText = totalOd;
    }

    // ‡•¨. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§®
    document.getElementById('planningForm').onsubmit = function(e) {
      e.preventDefault();
      showLoader(true);

      const fxData = [];
      document.querySelectorAll('#fxTableBody tr').forEach(row => {
        fxData.push({
          name: row.querySelector('.fx-name').value,
          disb: row.querySelector('.fx-disb').value,
          auto: row.querySelector('.fx-auto').value,
          odCount: row.querySelector('.fx-od-count').value,
          odAmt: row.querySelector('.fx-od-amt').value,
          pdAction: row.querySelector('.fx-pd-action').value,
          ach: row.querySelector('.fx-ach').value
        });
      });

      const payload = {
        manager: currentManager,
        sDate: document.getElementById('startDate').value,
        eDate: document.getElementById('endDate').value,
        fxDetails: fxData
      };

      google.script.run.withSuccessHandler(res => {
        showLoader(false);
        if (res.status === "SUCCESS") {
          alert(res.message);
          location.reload();
        } else {
          alert("Error: " + res.message);
        }
      }).submitPlan(payload);
    };

    function showLoader(show) {
      document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Management Portal</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0f172a; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <iframe src="https://script.google.com/macros/s/AKfycbzGN2HpYotIGaK77mpuxLENb_xsO6yeqgiKzRNq-1cvHv-utjAFmf_8KEHsS3lsMTMR/exec"></iframe>
</body>
</html>
