<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Fin - High Level Strategic Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-btn { padding: 10px 20px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-active { border-bottom: 3px solid #0056b3; color: #0056b3; background: #ebf4ff; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .input-box { border: 1.5px solid #e2e8f0; border-radius: 8px; padding: 8px; font-size: 13px; outline: none; width: 100%; }
        .input-box:focus { border-color: #0056b3; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="text-slate-900">

    <div id="loading" class="loader"><div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div><p class="mt-2 font-bold text-blue-800">डेटा सिंक होत आहे...</p></div>

    <nav class="bg-white border-b sticky top-0 z-40 p-4">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-10">
            <div class="flex items-center gap-3">
                <select id="mgrSelect" onchange="syncData()" class="p-3 rounded-xl border-2 border-blue-100 bg-blue-50 font-bold text-blue-900 outline-none">
                    <option value="">मॅनेजर निवडा...</option>
                </select>
            </div>
        </div>
    </nav>

    <main id="mainArea" class="max-w-7xl mx-auto p-4 md:p-8 space-y-8 hidden">
        
        <!-- Tabs -->
        <div class="flex border-b">
            <div id="tab1" class="tab-btn tab-active" onclick="switchTab(1)">Planning & Achievement</div>
            <div id="tab2" class="tab-btn" onclick="switchTab(2)">Master Data History</div>
        </div>

        <!-- Dashboard KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card p-5"><p class="text-[10px] font-bold text-gray-400 uppercase">Target Disb.</p><h3 id="kpiT" class="text-xl font-black text-blue-900">₹ 0</h3></div>
            <div class="card p-5"><p class="text-[10px] font-bold text-gray-400 uppercase">Actual Disb.</p><h3 id="kpiA" class="text-xl font-black text-emerald-600">₹ 0</h3></div>
            <div class="card p-5"><p class="text-[10px] font-bold text-gray-400 uppercase">Achievement</p><h3 id="kpiP" class="text-xl font-black text-orange-500">0%</h3></div>
            <div class="card p-5"><p class="text-[10px] font-bold text-gray-400 uppercase">Total FX</p><h3 id="kpiF" class="text-xl font-black text-purple-600">0</h3></div>
        </div>

        <!-- Section 1: Planning & Achievement -->
        <div id="section1" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[300px]">
                <div class="card p-4"><canvas id="chart1"></canvas></div>
                <div class="card p-4"><canvas id="chart2"></canvas></div>
            </div>

            <form id="planForm" class="card overflow-hidden">
                <div class="p-6 bg-slate-50 border-b flex flex-col md:flex-row gap-4">
                    <div class="flex-grow"><label class="text-[11px] font-bold text-gray-500 block uppercase">Start Date</label><input type="date" id="sDate" required class="input-box"></div>
                    <div class="flex-grow"><label class="text-[11px] font-bold text-gray-500 block uppercase">End Date</label><input type="date" id="eDate" required class="input-box"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-[10px] font-bold uppercase">
                            <tr>
                                <th class="p-4 text-left">FX Unit</th>
                                <th class="p-4">Target Disb</th>
                                <th class="p-4">Actual Disb</th>
                                <th class="p-4">OD (Plan|Act)</th>
                                <th class="p-4">Past Due Action</th>
                            </tr>
                        </thead>
                        <tbody id="fxTable"></tbody>
                    </table>
                </div>
                <div class="p-6 text-center"><button type="submit" class="bg-blue-700 text-white px-10 py-3 rounded-xl font-bold hover:scale-105 transition">Submit Week Plan/Results</button></div>
            </form>
        </div>

        <!-- Section 2: Master Data History -->
        <div id="section2" class="hidden animate-in fade-in">
            <div class="card overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-800 text-white text-[10px] uppercase">
                        <tr>
                            <th class="p-4 text-left">Period</th>
                            <th class="p-4">Total Target</th>
                            <th class="p-4">Total Achieved</th>
                            <th class="p-4">Efficiency</th>
                            <th class="p-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzJfEgqkdMqr_OFA-xgHt2j3kTmq730XQiUJrDEuyr8qLkKgfFtxYmhHAjKWO5NJ6Sd/exec";
        let managerData = { fxList: [], history: [] };
        let charts = {};

        window.onload = () => {
            toggleLoader(true);
            fetch(`${API}?action=getManagers`).then(r => r.json()).then(d => {
                const s = document.getElementById('mgrSelect');
                d.forEach(m => s.add(new Option(m,m)));
                toggleLoader(false);
            });
        };

        async function syncData() {
            const m = document.getElementById('mgrSelect').value;
            if(!m) return;
            toggleLoader(true);
            const r = await fetch(`${API}?action=getManagerFullData&manager=${encodeURIComponent(m)}`);
            managerData = await r.json();
            
            document.getElementById('mainArea').classList.remove('hidden');
            renderTable();
            renderHistory();
            updateKPIs();
            toggleLoader(false);
        }

        function renderTable() {
            const b = document.getElementById('fxTable');
            b.innerHTML = managerData.fxList.map(fx => `
                <tr class="border-b">
                    <td class="p-4 font-bold text-blue-900">${fx}<input type="hidden" class="fx-name" value="${fx}"></td>
                    <td class="p-2"><input type="number" class="t-disb input-box" placeholder="Target ₹" oninput="updateKPIs()"></td>
                    <td class="p-2"><input type="number" class="a-disb input-box bg-emerald-50" placeholder="Actual ₹" oninput="updateKPIs()"></td>
                    <td class="p-2 flex gap-1"><input type="number" class="t-od w-1/2 input-box" placeholder="P"><input type="number" class="a-od w-1/2 input-box bg-emerald-50" placeholder="A"></td>
                    <td class="p-2"><input type="text" class="p-action input-box" placeholder="Action taken..."></td>
                </tr>
            `).join('');
        }

        function updateKPIs() {
            let tD = 0, aD = 0;
            document.querySelectorAll('.t-disb').forEach(i => tD += Number(i.value || 0));
            document.querySelectorAll('.a-disb').forEach(i => aD += Number(i.value || 0));
            
            document.getElementById('kpiT').innerText = "₹ " + tD.toLocaleString();
            document.getElementById('kpiA').innerText = "₹ " + aD.toLocaleString();
            document.getElementById('kpiP').innerText = tD > 0 ? ((aD/tD)*100).toFixed(1) + "%" : "0%";
            document.getElementById('kpiF').innerText = managerData.fxList.length;

            renderCharts(tD, aD);
        }

        function renderCharts(t, a) {
            const ctx1 = document.getElementById('chart1');
            if(charts.c1) charts.c1.destroy();
            charts.c1 = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: ['Planned', 'Achieved'], datasets: [{ data: [t, a], backgroundColor: ['#e2e8f0', '#0056b3'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderHistory() {
            const b = document.getElementById('historyTable');
            b.innerHTML = managerData.history.map(h => {
                let hT = 0, hA = 0;
                h.details.forEach(d => { hT += Number(d.tDisb); hA += Number(d.aDisb); });
                return `
                <tr class="border-b hover:bg-gray-50 text-xs">
                    <td class="p-4 font-bold">${h.sDate} to ${h.eDate}</td>
                    <td class="p-4">₹ ${hT.toLocaleString()}</td>
                    <td class="p-4 font-bold text-emerald-600">₹ ${hA.toLocaleString()}</td>
                    <td class="p-4 font-bold text-orange-600">${((hA/hT)*100).toFixed(1)}%</td>
                    <td class="p-4"><button onclick='viewDetails(${JSON.stringify(h.details)})' class="text-blue-600 font-bold underline">View</button></td>
                </tr>`;
            }).reverse().join('');
        }

        document.getElementById('planForm').onsubmit = async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const fxDetails = [];
            document.querySelectorAll('#fxTable tr').forEach(row => {
                fxDetails.push({
                    name: row.querySelector('.fx-name').value,
                    tDisb: row.querySelector('.t-disb').value,
                    aDisb: row.querySelector('.a-disb').value,
                    tOd: row.querySelector('.t-od').value,
                    aOd: row.querySelector('.a-od').value,
                    pd: row.querySelector('.p-action').value
                });
            });

            const payload = {
                manager: document.getElementById('mgrSelect').value,
                sDate: document.getElementById('sDate').value,
                eDate: document.getElementById('eDate').value,
                fxDetails: fxDetails
            };

            const r = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
            const res = await r.json();
            alert(res.message);
            if(res.status === "SUCCESS") location.reload();
            toggleLoader(false);
        };

        function switchTab(n) {
            document.getElementById('section1').classList.toggle('hidden', n !== 1);
            document.getElementById('section2').classList.toggle('hidden', n !== 2);
            document.getElementById('tab1').classList.toggle('tab-active', n === 1);
            document.getElementById('tab2').classList.toggle('tab-active', n === 2);
        }

        function toggleLoader(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
    </script>
</body>
</html>
